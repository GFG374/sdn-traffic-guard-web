# API速率限制使用指南

## 问题描述

在使用网络管理平台的AI功能时，您可能会遇到以下错误：
- "API请求过于频繁，请稍后再试"
- "429 Too Many Requests"
- 其他HTTP错误状态码（401、403、500、503等）

## 错误原因

### 1. 429错误（请求过于频繁）
- **原因**: Kimi API对每分钟的请求次数和token使用量有限制
- **默认限制**: 每分钟最多30次请求，10万个token
- **触发条件**: 短时间内发送大量请求或处理大量文本

### 2. 其他常见错误
- **401错误**: API密钥无效或未配置
- **403错误**: 权限不足或API配额用尽
- **500/503错误**: 服务器内部错误或服务不可用

## 解决方案

### 即时解决方案
1. **等待重试**: 对于429错误，系统会自动等待并重试（最多3次）
2. **减少请求频率**: 避免短时间内发送大量请求
3. **分批处理**: 对于大量文本，分批发送而不是一次性处理

### 长期解决方案
1. **配置API密钥**: 确保正确设置KIMI_API_KEY环境变量
2. **监控使用情况**: 定期检查API使用统计
3. **升级配额**: 如果需要更高限制，联系API服务提供商

## 系统内置保护机制

### 1. 速率限制器
- 自动跟踪每分钟的请求次数和token使用量
- 在接近限制时自动排队等待
- 提供友好的错误提示和重试建议

### 2. 错误处理
- 自动识别不同类型的API错误
- 提供针对性的解决方案建议
- 记录详细的错误信息供技术支持使用

### 3. 重试机制
- 自动重试失败的请求（最多3次）
- 使用指数退避策略避免加重服务器负担
- 在可恢复错误时提供继续使用的选项

## 配置说明

### 环境变量配置
```bash
# 设置Kimi API密钥
export KIMI_API_KEY="your_api_key_here"

# 设置DashScope API密钥（用于文本嵌入）
export DASHSCOPE_API_KEY="your_dashscope_api_key_here"
```

### 速率限制配置（backend/config/api_config.py）
```python
# 默认配置
kimi_rate_limit_config = APIRateLimitConfig(
    max_requests_per_minute=30,    # 每分钟最大请求数
    max_tokens_per_minute=100000,  # 每分钟最大token数
    retry_delay_seconds=5,         # 重试延迟秒数
    max_retries=3                  # 最大重试次数
)
```

## 故障排除

### 常见问题排查
1. **检查API密钥**: 确认KIMI_API_KEY环境变量已正确设置
2. **查看错误日志**: 检查后端日志获取详细错误信息
3. **测试连接**: 使用简单的测试请求验证API连通性

### 技术支持
如果问题持续存在，请提供以下信息：
- 错误消息全文
- 发生时间
- 操作步骤
- 系统日志片段

## 最佳实践

1. **合理规划请求**: 避免高峰期集中发送大量请求
2. **使用缓存**: 对重复查询结果进行缓存
3. **监控使用**: 定期检查API使用统计和剩余配额
4. **错误处理**: 在客户端代码中妥善处理API错误

## 相关文件

- `backend/ai_service.py` - 主要的AI服务实现
- `backend/config/api_config.py` - API速率限制配置
- `backend/utils/error_handler.py` - 错误处理工具
- `backend/routes/ai.py` - AI功能API路由

---

*最后更新: 2024年*