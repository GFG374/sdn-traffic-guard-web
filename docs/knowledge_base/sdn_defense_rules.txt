# SDN项目防御规则和业务规则

## 项目防御架构

### 防御流程（RYU控制器实现）
黑名单 → 白名单 → 孤立森林异常检测 → LLM分析 → 限速处理 → 管理员确认

### 防御等级说明
1. **黑名单（最严厉）**: 直接丢弃所有流量，不经过任何处理
   - 优先级最高
   - 流表优先级: 50
   - 直接DROP，不限速

2. **白名单（最宽松）**: 直接放行，永不限速
   - 优先级最高
   - 永远不会被限速
   - 直接NORMAL转发

3. **异常检测**: 通过孤立森林算法检测异常流量
   - 训练期: 300秒
   - 污染率: 0.1（假设10%的异常）
   - 估计器: 100个

4. **LLM分析**: 对异常流量进行智能分析
   - 模型: Ollama + Mistral 7B（本地）
   - Embedding: 阿里云DashScope（云端）
   - 置信度阈值: 0.5

5. **限速处理**: 对可疑流量进行限速而不是直接阻断
   - 流表优先级: 50
   - 持续时间: 5分钟（300秒）
   - 使用OVS队列实现

6. **管理员确认**: 最终由管理员确认是否为真实攻击
   - 命令: `ai: 加黑 x.x.x.x`
   - 命令: `ai: 解除限速 x.x.x.x`
   - 命令: `ai: 加白 x.x.x.x`

## 攻击检测阈值配置（来自sdn_smart.py）

### ARP欺骗检测
- **MAC变化检测**: 1次变化即触发告警
  - 配置: `'mac_change': 1`
- **欺骗计数阈值**: 1次即判定为欺骗
  - 配置: `'spoof_cnt': 1`
- **防御措施**: ARP绑定、静态ARP表、DAI、VLAN隔离

### UDP Flood检测
- **流量速率阈值**: 200 pps（每秒包数）
  - 配置: `'flood_rate': 200`
- **判定标准**: 单个源IP的UDP包速率超过200 pps
- **防御措施**: 限速处理、黑名单、流量清洗

### ICMP Flood检测
- **流量速率阈值**: 2000 pps（避免正常ping误报）
  - 配置: `'flood_rate': 2000`
  - 注: 调高到2000是为了避免pingall误报
- **判定标准**: 单个源IP的ICMP包速率超过2000 pps
- **防御措施**: 限速处理、ICMP限制、黑名单

### SYN Flood检测
- **SYN包比例阈值**: 80%（SYN包占比超过80%）
  - 配置: `'ratio': 0.8`
- **流量速率阈值**: 200 pps
  - 配置: `'rate': 200`
- **最小TCP包数**: 20个（避免误报）
  - 配置: `'min_tcp': 20`
- **判定标准**: 同时满足上述三个条件
- **防御措施**: SYN Cookie、连接限制、限速处理

### 僵尸网络检测
- **目标IP数阈值**: 10个（单个源IP连接10个不同目标IP）
  - 配置: `'dst_ip_cnt': 10`
- **端口熵阈值**: 3.0（连接端口多样性指标）
  - 配置: `'port_entropy': 3.0`
- **包速率阈值**: 2000 pps
  - 配置: `'pkt_rate': 2000`
- **判定标准**: 同时满足上述条件
- **防御措施**: 端点防护、网络隔离、流量分析、威胁情报

## RYU控制器配置参数

### 孤立森林参数
```
n_estimators: 100         # 决策树数量
max_samples: 'auto'       # 每棵树的样本数
contamination: 0.1        # 污染率（异常比例）
random_state: 42          # 随机种子
n_jobs: -1                # 使用所有CPU核心
```

### 限速参数
```
RATE_LIMIT_DURATION: 300  # 限速持续时间（秒）
RATE_LIMIT_OPTIONS:
  - 低速: 256 Kbps
  - 中速: 1024 Kbps
  - 高速: 2048 Kbps
```

### 训练参数
```
training_seconds: 300     # 训练期时长（秒）
is_training: True/False   # 是否处于训练期
```

### 数据库配置
```
host: 192.168.44.1
user: root
password: yyr0218...
db: network_management
charset: utf8mb4
```

### Ollama配置
```
OLLAMA_URL: http://192.168.44.1:11435/api/generate
MEMORY_TURNS: 20          # 对话记忆轮数
```

### 其他配置
```
REALTIME_INSERT: True     # 原始流量实时写库
VALID_SUBNET: 192.168.1.0/24  # 合法IP网段
WINDOW_SEC: 30            # 滑动窗口（秒）
```

## 限速档位配置

### 限速等级
1. **低速**: 256 Kbps
   - 用途: 严重攻击，仅允许基本通信
   - 持续时间: 可配置（默认5分钟）
   - 场景: DDoS攻击、恶意IP

2. **中速**: 1024 Kbps (1 Mbps)
   - 用途: 中等攻击，保留部分服务可用性
   - 持续时间: 可配置（默认5分钟）
   - 场景: 异常流量、可疑行为

3. **高速**: 2048 Kbps (2 Mbps)
   - 用途: 轻微异常，基本保持正常服务
   - 持续时间: 可配置（默认5分钟）
   - 场景: 轻微异常、警告级别

4. **自定义**: 用户自定义速率
   - 用途: 特殊场景
   - 持续时间: 用户指定

### 限速时长
- **短期限速**: 5分钟（临时异常）
- **中期限速**: 30分钟（可疑行为）
- **长期限速**: 24小时（重复攻击）
- **默认限速**: 300秒（5分钟）

### QoS实现
- **Linux tc**: 基于HTB（Hierarchical Token Bucket）算法
- **OVS队列**: 通过OpenFlow队列实现
- **应用范围**: 每个主机连接端口独立配置
- **队列映射**:
  - Queue 1: 低速 (256 Kbps)
  - Queue 2: 中速 (1 Mbps)
  - Queue 3: 高速 (2 Mbps)

## 黑名单管理规则

### 何时加入黑名单
1. 确认的恶意IP
2. 多次重复攻击的IP（超过3次）
3. 已知的僵尸网络IP
4. 管理员手动确认的攻击源

### 黑名单管理
- **定期审查**: 每周检查黑名单有效性
- **误报处理**: 及时移除误加的IP
- **备份维护**: 定期备份黑名单数据
- **持久化**: 黑名单数据存储在MySQL数据库中，重启不丢失

### 黑名单操作命令
- **添加**: `ai: 加黑 x.x.x.x`
- **移除**: `ai: 解除黑名单 x.x.x.x`
- **查看**: 通过管理界面查看所有黑名单IP

## 白名单管理规则

### 白名单对象
1. 公司内部IP段（192.168.1.0/24）
2. 重要合作伙伴IP
3. 关键服务提供商IP
4. 管理员IP
5. 备份系统IP

### 白名单特性
- **永不限速**: 白名单IP的流量永远不会被限速
- **优先级最高**: 白名单优先级高于所有其他规则
- **直接放行**: 白名单流量直接放行，不经过异常检测

### 白名单操作
- **添加**: 通过管理界面添加
- **移除**: 通过管理界面移除
- **查看**: 通过管理界面查看所有白名单IP

## 异常隔离措施

### 隔离策略
1. **限速处理**: 降低异常IP的带宽到指定等级
2. **流量镜像**: 复制流量用于深度分析
3. **告警通知**: 立即通知安全团队
4. **日志记录**: 详细记录异常特征

### 隔离时间
- **临时隔离**: 5分钟（观察期）
- **中期隔离**: 30分钟（进一步分析）
- **长期隔离**: 24小时（确认攻击）

## LLM分析规则

### LLM分析触发条件
- 孤立森林检测到异常流量
- 异常流量不在黑名单或白名单中
- 需要进一步的智能分析

### LLM分析输出
- **合法判定**: confidence ≥ 0.5 → 立即限速（5分钟）
- **非法判定**: confidence < 0.5 → 只告警、不限速
- **风险等级**: 低/中/高/严重
- **建议措施**: 限速、黑名单、隔离等

### LLM分析参数
- **模型**: Ollama + Mistral 7B（本地）
- **Embedding**: 阿里云DashScope（云端）
- **温度参数**: 0.3（保证一致性）
- **最大输出**: 2000个token

## RYU控制器防御流程

### 完整防御流程
1. **流量采集** - RYU控制器采集所有Packet-In事件
2. **ACL检查** - 检查黑名单和白名单
   - 黑名单: 直接DROP
   - 白名单: 直接NORMAL转发
3. **特征提取** - 提取多维度流量特征
4. **异常检测** - 孤立森林算法检测异常
5. **LLM分析** - 对异常流量进行智能分析
   - confidence >= 0.5: 立即限速（5分钟）
   - confidence < 0.5: 只告警、不限速
6. **限速执行** - 通过OVS队列实现限速
7. **数据持久化** - 所有操作写入数据库
8. **管理员审核** - 管理员确认和处置

### 管理员操作命令（RYU Web界面）
- **加黑**: `ai: 加黑 x.x.x.x`
  - 效果: 将IP加入黑名单，直接DROP
  - 自动解除: 如果IP当前在限速，先卸掉
  - 记录: 插入attack_sessions表，status='handled'

- **解除限速**: `ai: 解除限速 x.x.x.x`
  - 效果: 移除限速规则
  - 学习: 同时增量学习（标记为误报）
  - 记录: 更新attack_sessions表

- **加白**: `ai: 加白 x.x.x.x`
  - 效果: 将IP加入白名单，永不限速
  - 优先级: 最高，直接NORMAL转发
  - 记录: 插入acl_entries表

- **查看状态**: `ai: 查看 x.x.x.x`
  - 显示: IP当前状态（黑名单/白名单/限速/正常）
  - 显示: 限速剩余时间、原因等

### 数据持久化

#### 黑白名单持久化
- **存储位置**: MySQL acl_entries表
- **恢复机制**: 系统启动时自动从数据库恢复
- **文件备份**: JSON文件（white_list.json, black_list.json）
- **优先级**: 数据库 > JSON文件

#### 限速规则持久化
- **存储位置**: MySQL rate_limit_active表
- **字段**: src_ip, kbps, reason, created_at, expire_at
- **恢复机制**: 系统启动时自动恢复未过期的限速规则
- **超时机制**: 5分钟硬超时（RATE_LIMIT_DURATION=300）

#### 流量日志持久化
- **原始流量**: 实时写库（REALTIME_INSERT=True）
- **异常日志**: anomaly_traffic.log
- **汇总数据**: anomaly_summary.json
- **攻击会话**: attack_sessions表

### 流表管理

#### 流表优先级
- **黑名单**: 优先级50（最高）
  - 匹配: eth_type=IP, ipv4_src=黑名单IP
  - 动作: DROP

- **限速**: 优先级50
  - 匹配: eth_type=IP, ipv4_src=限速IP
  - 动作: SetQueue(queue_id) + NORMAL

- **白名单**: 优先级50
  - 匹配: eth_type=IP, ipv4_src=白名单IP
  - 动作: NORMAL

#### OVS队列映射
- **Queue 1**: 低速 (256 Kbps)
- **Queue 2**: 中速 (1 Mbps)
- **Queue 3**: 高速 (2 Mbps)

### 异常检测和LLM分析

#### 孤立森林检测
- **触发条件**: 流量特征异常
- **输出**: 异常分数
- **阈值**: contamination=0.1（异常比例）

#### LLM分析
- **输入**: 异常流量特征 + 知识库信息
- **输出**: 
  - 攻击类型识别
  - 风险等级评估
  - 置信度评分
  - 建议防御措施

- **决策规则**:
  - confidence >= 0.5 且判定为"合法": 立即限速（5分钟）
  - confidence < 0.5 或判定为"非法": 只告警、不限速

#### 增量学习
- **误报处理**: 管理员解除限速时触发
- **学习内容**: 标记为误报的流量特征
- **优化目标**: 降低误报率

## 数据持久化

### 数据库配置
- **数据库**: MySQL (network_management)
- **主机**: 192.168.44.1
- **用户**: root
- **字符集**: utf8mb4

### 持久化数据
1. **黑名单**: 存储在MySQL中，重启不丢失
2. **白名单**: 存储在MySQL中，重启不丢失
3. **限速记录**: 实时写入数据库
4. **流量日志**: 原始流量实时写库（REALTIME_INSERT = True）
5. **异常日志**: 所有异常事件记录

### 数据恢复
- 系统启动时自动从数据库恢复黑名单、白名单、限速状态
- 确保防御规则在系统重启后继续生效

## 性能优化

### 孤立森林配置
- **估计器数量**: 100个
- **最大样本**: auto（自动计算）
- **污染率**: 0.1（假设10%的异常）
- **随机种子**: 42（保证可重复性）
- **并行处理**: n_jobs=-1（使用所有CPU核心）

### 检测参数
- **检测周期**: 实时检测
- **样本窗口**: 最近N个包
- **特征维度**: 多维度流量特征
- **更新频率**: 每秒更新一次模型

## 网络特性

### 星形拓扑特性
- **单点故障**: s1是单点故障点
- **流量集中**: 所有流量都经过s1
- **延迟低**: 任意两个主机间延迟 < 2ms
- **带宽限制**: 每条主机链路最大100Mbps

### 防御优势
- **集中管理**: 所有流量在s1处理，便于监控
- **快速响应**: 限速规则快速生效
- **精细控制**: 支持每个主机级别的限速

### 防御劣势
- **单点故障**: s1故障导致整个网络中断
- **带宽瓶颈**: s1可能成为性能瓶颈
- **扩展性差**: 主机数量受限于交换机端口数

