<template>
  <div class="min-h-screen bg-gray-50 font-inter">
    <main class="container mx-auto px-4 py-6">
      
      <!-- ğŸ¨ é¡¶éƒ¨åŒºåŸŸï¼šç½‘ç»œæ‹“æ‰‘ + æ§åˆ¶å™¨çŠ¶æ€ (ä¸¤åˆ—å¸ƒå±€) -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        
        <!-- å·¦ä¾§ï¼šç½‘ç»œæ‹“æ‰‘ (å 2åˆ—) -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow-md border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
              <span class="text-blue-600">ğŸ“¡</span>
              <span>ç½‘ç»œæ‹“æ‰‘</span>
            </h3>
            <span class="text-xs text-gray-500">å®æ—¶åŒæ­¥ â€¢ RYUå¯è§†åŒ–</span>
          </div>
          <div class="topology-container">
            <svg viewBox="0 0 800 400" class="w-full h-auto">
              <!-- å®šä¹‰æ¸å˜å’Œæ ·å¼ -->
              <defs>
                <!-- äº¤æ¢æœºæ¸å˜ -->
                <linearGradient id="switchGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#4c51bf;stop-opacity:1" />
                </linearGradient>
                <!-- ä¸»æœºæ¸å˜ -->
                <linearGradient id="hostGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#34d399;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
                </linearGradient>
                <!-- é˜´å½±æ•ˆæœ -->
                <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                  <feOffset dx="0" dy="2" result="offsetblur"/>
                  <feComponentTransfer>
                    <feFuncA type="linear" slope="0.3"/>
                  </feComponentTransfer>
                  <feMerge>
                    <feMergeNode/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
              </defs>
              
              <!-- äº¤æ¢æœº - ä¸“ä¸šå›¾æ ‡ -->
              <g id="switch" filter="url(#shadow)">
                <!-- ä¸»ä½“ -->
                <rect x="340" y="165" width="120" height="70" rx="8" fill="url(#switchGradient)" stroke="#4c51bf" stroke-width="2"/>
                <!-- é¡¶éƒ¨è£…é¥°æ¡ -->
                <rect x="340" y="165" width="120" height="12" rx="8" fill="#5a67d8" opacity="0.5"/>
                <!-- ç«¯å£æŒ‡ç¤ºç¯ -->
                <circle cx="360" cy="195" r="3" fill="#48bb78"/>
                <circle cx="375" cy="195" r="3" fill="#48bb78"/>
                <circle cx="390" cy="195" r="3" fill="#48bb78"/>
                <circle cx="405" cy="195" r="3" fill="#48bb78"/>
                <circle cx="420" cy="195" r="3" fill="#48bb78"/>
                <circle cx="435" cy="195" r="3" fill="#48bb78"/>
                <!-- æ–‡å­— -->
                <text x="400" y="220" text-anchor="middle" fill="white" font-weight="bold" font-size="14">äº¤æ¢æœº S1</text>
                <!-- åº•éƒ¨é€šé£å­”è£…é¥° -->
                <line x1="350" y1="225" x2="450" y2="225" stroke="#5a67d8" stroke-width="1" opacity="0.3"/>
              </g>
              
              <!-- 8ä¸ªä¸»æœº - ç”µè„‘å›¾æ ‡æ ·å¼ -->
              <!-- h1 (192.168.1.100) - ä¸Š -->
              <g class="host" @click="selectHost('h1')" filter="url(#shadow)">
                <!-- æ˜¾ç¤ºå™¨ -->
                <rect x="375" y="30" width="50" height="35" rx="3" fill="url(#hostGradient)" stroke="#059669" stroke-width="2"/>
                <rect x="380" y="35" width="40" height="25" rx="2" fill="#1e293b"/>
                <!-- æ”¯æ¶ -->
                <rect x="395" y="65" width="10" height="8" fill="#059669"/>
                <rect x="385" y="73" width="30" height="3" rx="1" fill="#059669"/>
                <!-- æ ‡ç­¾ -->
                <text x="400" y="95" text-anchor="middle" fill="#374151" font-weight="bold" font-size="12">H1</text>
                <text x="400" y="107" text-anchor="middle" fill="#6b7280" font-size="10">.100</text>
                <!-- è¿æ¥çº¿ -->
                <line x1="400" y1="76" x2="400" y2="165" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,3"/>
              </g>
              
              <!-- h8 (192.168.1.108) - å³ä¸Š -->
              <g class="host" @click="selectHost('h8')" filter="url(#shadow)">
                <rect x="525" y="75" width="50" height="35" rx="3" fill="url(#hostGradient)" stroke="#059669" stroke-width="2"/>
                <rect x="530" y="80" width="40" height="25" rx="2" fill="#1e293b"/>
                <rect x="545" y="110" width="10" height="8" fill="#059669"/>
                <rect x="535" y="118" width="30" height="3" rx="1" fill="#059669"/>
                <text x="550" y="138" text-anchor="middle" fill="#374151" font-weight="bold" font-size="12">H8</text>
                <text x="550" y="150" text-anchor="middle" fill="#6b7280" font-size="10">.108</text>
                <line x1="540" y1="121" x2="440" y2="180" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,3"/>
              </g>
              
              <!-- h2 (192.168.1.101) - å³ -->
              <g class="host" @click="selectHost('h2')" filter="url(#shadow)">
                <rect x="575" y="182" width="50" height="35" rx="3" fill="url(#hostGradient)" stroke="#059669" stroke-width="2"/>
                <rect x="580" y="187" width="40" height="25" rx="2" fill="#1e293b"/>
                <rect x="595" y="217" width="10" height="8" fill="#059669"/>
                <rect x="585" y="225" width="30" height="3" rx="1" fill="#059669"/>
                <text x="630" y="205" text-anchor="start" fill="#374151" font-weight="bold" font-size="12">H2</text>
                <text x="630" y="217" text-anchor="start" fill="#6b7280" font-size="10">.101</text>
                <line x1="575" y1="200" x2="460" y2="200" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,3"/>
              </g>
              
              <!-- h3 (192.168.1.102) - å³ä¸‹ -->
              <g class="host" @click="selectHost('h3')" filter="url(#shadow)">
                <rect x="525" y="270" width="50" height="35" rx="3" fill="url(#hostGradient)" stroke="#059669" stroke-width="2"/>
                <rect x="530" y="275" width="40" height="25" rx="2" fill="#1e293b"/>
                <rect x="545" y="305" width="10" height="8" fill="#059669"/>
                <rect x="535" y="313" width="30" height="3" rx="1" fill="#059669"/>
                <text x="550" y="335" text-anchor="middle" fill="#374151" font-weight="bold" font-size="12">H3</text>
                <text x="550" y="347" text-anchor="middle" fill="#6b7280" font-size="10">.102</text>
                <line x1="540" y1="270" x2="440" y2="220" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,3"/>
              </g>
              
              <!-- h4 (192.168.1.103) - ä¸‹ -->
              <g class="host" @click="selectHost('h4')" filter="url(#shadow)">
                <rect x="375" y="320" width="50" height="35" rx="3" fill="url(#hostGradient)" stroke="#059669" stroke-width="2"/>
                <rect x="380" y="325" width="40" height="25" rx="2" fill="#1e293b"/>
                <rect x="395" y="355" width="10" height="8" fill="#059669"/>
                <rect x="385" y="363" width="30" height="3" rx="1" fill="#059669"/>
                <text x="400" y="383" text-anchor="middle" fill="#374151" font-weight="bold" font-size="12">H4</text>
                <text x="400" y="395" text-anchor="middle" fill="#6b7280" font-size="10">.103</text>
                <line x1="400" y1="320" x2="400" y2="235" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,3"/>
              </g>
              
              <!-- h5 (192.168.1.104) - å·¦ä¸‹ -->
              <g class="host" @click="selectHost('h5')" filter="url(#shadow)">
                <rect x="225" y="270" width="50" height="35" rx="3" fill="url(#hostGradient)" stroke="#059669" stroke-width="2"/>
                <rect x="230" y="275" width="40" height="25" rx="2" fill="#1e293b"/>
                <rect x="245" y="305" width="10" height="8" fill="#059669"/>
                <rect x="235" y="313" width="30" height="3" rx="1" fill="#059669"/>
                <text x="250" y="335" text-anchor="middle" fill="#374151" font-weight="bold" font-size="12">H5</text>
                <text x="250" y="347" text-anchor="middle" fill="#6b7280" font-size="10">.104</text>
                <line x1="260" y1="270" x2="360" y2="220" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,3"/>
              </g>
              
              <!-- h6 (192.168.1.105) - å·¦ -->
              <g class="host" @click="selectHost('h6')" filter="url(#shadow)">
                <rect x="175" y="182" width="50" height="35" rx="3" fill="url(#hostGradient)" stroke="#059669" stroke-width="2"/>
                <rect x="180" y="187" width="40" height="25" rx="2" fill="#1e293b"/>
                <rect x="195" y="217" width="10" height="8" fill="#059669"/>
                <rect x="185" y="225" width="30" height="3" rx="1" fill="#059669"/>
                <text x="170" y="205" text-anchor="end" fill="#374151" font-weight="bold" font-size="12">H6</text>
                <text x="170" y="217" text-anchor="end" fill="#6b7280" font-size="10">.105</text>
                <line x1="225" y1="200" x2="340" y2="200" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,3"/>
              </g>
              
              <!-- h7 (192.168.1.200) - å·¦ä¸Š -->
              <g class="host" @click="selectHost('h7')" filter="url(#shadow)">
                <rect x="225" y="75" width="50" height="35" rx="3" fill="url(#hostGradient)" stroke="#059669" stroke-width="2"/>
                <rect x="230" y="80" width="40" height="25" rx="2" fill="#1e293b"/>
                <rect x="245" y="110" width="10" height="8" fill="#059669"/>
                <rect x="235" y="118" width="30" height="3" rx="1" fill="#059669"/>
                <text x="250" y="138" text-anchor="middle" fill="#374151" font-weight="bold" font-size="12">H7</text>
                <text x="250" y="150" text-anchor="middle" fill="#6b7280" font-size="10">.200</text>
                <line x1="260" y1="121" x2="360" y2="180" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,3"/>
              </g>
              
              <!-- æµè¡¨å‘é€åŠ¨ç”»ç®­å¤´ -->
              <g v-if="showFlowAnimation" class="flow-animation">
                <defs>
                  <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#ef4444" />
                  </marker>
                </defs>
                <line 
                  :x1="flowAnimSrc.x" 
                  :y1="flowAnimSrc.y" 
                  :x2="flowAnimDst.x" 
                  :y2="flowAnimDst.y" 
                  stroke="#ef4444" 
                  stroke-width="3" 
                  marker-end="url(#arrowhead)"
                  class="animated-arrow"
                />
                <text 
                  :x="(flowAnimSrc.x + flowAnimDst.x) / 2" 
                  :y="(flowAnimSrc.y + flowAnimDst.y) / 2 - 10" 
                  text-anchor="middle" 
                  fill="#ef4444" 
                  font-weight="bold" 
                  font-size="12"
                  class="animated-text"
                >
                  æµè¡¨å·²ä¸‹å‘
                </text>
              </g>
            </svg>
          </div>
          <div class="px-6 py-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-600">
            ğŸ’¡ æç¤ºï¼š8ä¸ªä¸»æœºåœ¨192.168.1.0/24ç½‘æ®µ (.100, .101, .102, .103, .104, .105, .108, .200)
          </div>
        </div>
        
        <!-- å³ä¾§ï¼šæ§åˆ¶å™¨çŠ¶æ€ (å 1åˆ—) -->
        <div class="bg-white rounded-lg shadow-md border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
              <span class="text-blue-600">ğŸ›ï¸</span>
              <span>æ§åˆ¶å™¨çŠ¶æ€</span>
            </h3>
          </div>
          <div class="p-6 space-y-4">
            <!-- åœ¨çº¿çŠ¶æ€ -->
            <div class="flex items-center justify-between pb-3 border-b border-gray-100">
              <span class="text-sm text-gray-600">äº¤æ¢æœº</span>
              <span class="text-2xl font-bold text-gray-900">{{ switches.length }}</span>
            </div>
            <div class="flex items-center justify-between pb-3 border-b border-gray-100">
              <span class="text-sm text-gray-600">ä¸»æœº</span>
              <span class="text-2xl font-bold text-gray-900">8</span>
            </div>
            <div class="flex items-center justify-between pb-3 border-b border-gray-100">
              <span class="text-sm text-gray-600">ä¸»æ§åˆ¶å™¨</span>
              <span class="text-sm font-mono text-blue-600">192.168.44.129:8080</span>
            </div>
            
            <!-- ç½‘æ®µä¿¡æ¯ -->
            <div class="pt-2">
              <div class="text-xs text-gray-500 mb-2">ç½‘æ®µï¼š</div>
              <div class="bg-gray-50 px-3 py-2 rounded text-xs font-mono text-gray-700">
                192.168.1.0/24
              </div>
              <div class="mt-2 text-xs text-gray-500">
                ä¸»æ§åœ°å€ï¼šç”¨äºè¿æ¥RYUæ§åˆ¶å™¨
              </div>
            </div>
            
            <!-- IPåˆ—è¡¨ -->
            <div class="pt-2">
              <div class="text-xs text-gray-500 mb-2">IPï¼š</div>
              <div class="flex flex-wrap gap-1">
                <span v-for="ip in ['101', '102', '103', '104', '105', '106', '108', '200']" :key="ip"
                      class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-mono">
                  .{{ ip }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ğŸš¨ è®¾å¤‡å¼‚å¸¸ç›‘æ§åŒºåŸŸ -->
      <div class="mb-6 bg-white rounded-lg shadow-md border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
            <span class="text-orange-500">âš ï¸</span>
            <span>è®¾å¤‡å¼‚å¸¸ç›‘æ§</span>
          </h3>
          <div class="flex items-center gap-3">
            <select v-model="statusFilter" @change="loadDeviceAnomalies"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 bg-white">
              <option value="all">å…¨éƒ¨</option>
              <option value="pending">æœªå¤„ç†</option>
              <option value="handled">å·²å¤„ç†</option>
            </select>
            <button @click="loadDeviceAnomalies" 
                    class="px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition-all flex items-center gap-2">
              <span>ğŸ”„</span>
              <span>åˆ·æ–°</span>
            </button>
          </div>
        </div>
        
        <!-- æ— å¼‚å¸¸çŠ¶æ€ -->
        <div v-if="deviceAnomalies.length === 0" 
             class="p-16 text-center bg-gradient-to-br from-green-50 to-emerald-50">
          <div class="inline-flex items-center justify-center w-20 h-20 bg-green-500 rounded-full mb-4">
            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <p class="text-2xl font-bold text-green-700 mb-2">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</p>
          <p class="text-sm text-gray-600">æœªæ£€æµ‹åˆ°è®¾å¤‡å¼‚å¸¸</p>
        </div>
        
        <!-- æœ‰å¼‚å¸¸æ—¶æ˜¾ç¤ºåˆ—è¡¨ -->
        <div v-else class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div v-for="anomaly in deviceAnomalies" :key="anomaly.id" 
                 class="bg-white p-4 rounded-lg border-2 hover:shadow-lg transition-all"
                 :class="{
                   'border-red-300 bg-red-50': anomaly.severity === 'high',
                   'border-yellow-300 bg-yellow-50': anomaly.severity === 'medium',
                   'border-blue-300 bg-blue-50': anomaly.severity === 'low'
                 }">
              <div class="flex items-start justify-between mb-3">
                <span class="px-2 py-1 rounded text-xs font-bold"
                      :class="{
                        'bg-red-600 text-white': anomaly.severity === 'high',
                        'bg-yellow-600 text-white': anomaly.severity === 'medium',
                        'bg-blue-600 text-white': anomaly.severity === 'low'
                      }">
                  {{ anomaly.severity.toUpperCase() }}
                </span>
                <span class="px-2 py-1 rounded text-xs font-medium"
                      :class="{
                        'bg-orange-200 text-orange-800': anomaly.status === 'pending',
                        'bg-green-200 text-green-800': anomaly.status === 'handled'
                      }">
                  {{ anomaly.status === 'pending' ? 'å¾…å¤„ç†' : 'å·²å¤„ç†' }}
                </span>
              </div>
              <h4 class="font-bold text-gray-800 text-sm mb-2">{{ anomaly.anomaly_type }}</h4>
              <p class="text-xs text-gray-600 mb-2 leading-relaxed">{{ anomaly.description }}</p>
              <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                <span class="font-mono">{{ anomaly.device_id }}</span>
                <span>{{ anomaly.detected_at }}</span>
              </div>
              <!-- âœ… æ–°å¢ï¼šå·²å¤„ç†æŒ‰é’® -->
              <div class="flex gap-2">
                <button 
                  @click="markAnomalyAsResolved(anomaly.id)"
                  class="flex-1 px-3 py-2 text-xs font-bold text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors duration-200 flex items-center justify-center gap-1.5"
                >
                  <i class="fa fa-check text-xs"></i>
                  <span>å·²å¤„ç†</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æµè¡¨ç®¡ç† -->
      <div class="bg-white rounded-lg shadow-md border border-gray-200 mb-6">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
            <span class="text-blue-600">ğŸ“Š</span>
            <span>æµè¡¨ç®¡ç†</span>
          </h3>
          <div class="flex items-center gap-3">
            <select v-model="selectedSwitch" @change="loadFlows" 
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-100 bg-white">
              <option value="">-- è¯·é€‰æ‹©äº¤æ¢æœº --</option>
              <option v-for="sw in switches" :key="sw" :value="sw">
                äº¤æ¢æœº S{{ sw }}
              </option>
            </select>
            <button @click="refreshData" :disabled="loading"
                    class="px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition-all disabled:opacity-50">
              ğŸ”„ åˆ·æ–°
            </button>
            <button @click="showAddModal = true" :disabled="!selectedSwitch"
                    class="px-4 py-2 bg-purple-500 text-white text-sm rounded-lg hover:bg-purple-600 transition-all disabled:opacity-50">
              â• æ·»åŠ æµè¡¨
            </button>
            <button @click="showTemplateModal = true" :disabled="!selectedSwitch"
                    class="px-4 py-2 bg-yellow-500 text-white text-sm rounded-lg hover:bg-yellow-600 transition-all disabled:opacity-50">
              ğŸš€ å¿«é€Ÿåœºæ™¯
            </button>
          </div>
        </div>

        <!-- åŠ è½½/ç©ºçŠ¶æ€ -->
        <div v-if="loading" class="p-12 text-center text-gray-500">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-2"></div>
          <p>åŠ è½½ä¸­...</p>
        </div>
        
        <div v-else-if="!selectedSwitch" class="p-12 text-center text-gray-400">
          <p class="text-lg">ğŸ‘† è¯·é€‰æ‹©ä¸€ä¸ªäº¤æ¢æœºæŸ¥çœ‹æµè¡¨</p>
        </div>

        <!-- æµè¡¨åˆ—è¡¨ -->
        <div v-else-if="flows.length > 0" class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ä¼˜å…ˆçº§</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">åŒ¹é…å­—æ®µ</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">åŠ¨ä½œ</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">åŒ…è®¡æ•°</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">å­—èŠ‚æ•°</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <tr v-for="(flow, index) in flows" :key="index" class="hover:bg-gray-50">
                <td class="px-4 py-3">
                  <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold">
                    {{ flow.priority }}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm text-gray-700">
                  <div v-if="Object.keys(flow.match).length > 0" class="space-y-1">
                    <div v-for="(value, key) in flow.match" :key="key" class="flex items-center gap-1">
                      <span class="font-medium text-gray-600">{{ formatMatchKey(key) }}:</span>
                      <span>{{ formatMatchValue(key, value) }}</span>
                    </div>
                  </div>
                  <span v-else class="text-gray-400 italic">åŒ¹é…æ‰€æœ‰</span>
                </td>
                <td class="px-4 py-3 text-sm">
                  <div v-if="flow.actions && flow.actions.length > 0" class="space-y-1">
                    <div v-for="(action, idx) in flow.actions" :key="idx">
                      {{ formatAction(action) }}
                    </div>
                  </div>
                  <div v-else class="text-red-600 font-medium">
                    ğŸš« ä¸¢å¼ƒ
                  </div>
                </td>
                <td class="px-4 py-3 text-sm font-mono text-gray-700">{{ flow.packet_count || 0 }}</td>
                <td class="px-4 py-3 text-sm font-mono text-gray-700">{{ formatBytes(flow.byte_count || 0) }}</td>
                <td class="px-4 py-3">
                  <div class="flex items-center gap-2">
                    <button @click="viewDetails(flow)" 
                            class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                      æŸ¥çœ‹
                    </button>
                    <button @click="deleteFlow(flow)" 
                            class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                      åˆ é™¤
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div v-else class="p-12 text-center text-gray-400">
          <p class="text-lg">ğŸ“‹ è¯¥äº¤æ¢æœºæš‚æ— æµè¡¨é¡¹</p>
          <p class="text-sm mt-2">ç‚¹å‡»"æ·»åŠ æµè¡¨"æˆ–"å¿«é€Ÿåœºæ™¯"å¼€å§‹é…ç½®</p>
        </div>
      </div>

    <!-- æ·»åŠ æµè¡¨æ¨¡æ€æ¡† -->
    <div v-if="showAddModal" class="modal-overlay" @click.self="showAddModal = false">
      <div class="modal large">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-gray-800">â• æ·»åŠ æµè¡¨</h3>
          <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600 text-2xl">âœ•</button>
        </div>
        
        <!-- âœ… ç¬¬1æ­¥ï¼šé€‰æ‹©åœºæ™¯ç±»å‹ -->
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-700 mb-3">ğŸ¯ é€‰æ‹©åœºæ™¯ç±»å‹</label>
          <div class="grid grid-cols-2 gap-3">
            <button @click="newFlow.scenarioType = 'forward'" 
                    :class="newFlow.scenarioType === 'forward' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700'"
                    class="p-4 rounded-xl font-medium hover:shadow-md transition-all">
              ğŸ“¤ å…è®¸è½¬å‘
            </button>
            <button @click="newFlow.scenarioType = 'block'" 
                    :class="newFlow.scenarioType === 'block' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-700'"
                    class="p-4 rounded-xl font-medium hover:shadow-md transition-all">
              ğŸš« å°ç¦é˜»æ­¢
            </button>
            <button @click="newFlow.scenarioType = 'ratelimit'" 
                    :class="newFlow.scenarioType === 'ratelimit' ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-700'"
                    class="p-4 rounded-xl font-medium hover:shadow-md transition-all">
              âš¡ é™é€Ÿæ§åˆ¶
            </button>
            <button @click="newFlow.scenarioType = 'custom'" 
                    :class="newFlow.scenarioType === 'custom' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700'"
                    class="p-4 rounded-xl font-medium hover:shadow-md transition-all">
              âš™ï¸ è‡ªå®šä¹‰
            </button>
          </div>
        </div>
        
        <!-- âœ… ç¬¬2æ­¥ï¼šæ ¹æ®åœºæ™¯ç±»å‹æ˜¾ç¤ºå­—æ®µ -->
        <div v-if="newFlow.scenarioType" class="space-y-6">
          
          <!-- åœºæ™¯1ï¼šå…è®¸è½¬å‘ -->
          <div v-if="newFlow.scenarioType === 'forward'" class="bg-blue-50 p-6 rounded-xl border-2 border-blue-200">
            <h4 class="font-semibold text-blue-900 mb-4 flex items-center gap-2">
              <span>ğŸ“¤</span>
              <span>å…è®¸è½¬å‘é…ç½®</span>
            </h4>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æºIP</label>
                <input type="text" v-model="newFlow.match.ipv4_src" placeholder="192.168.1.100" 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡IP</label>
                <input type="text" v-model="newFlow.match.ipv4_dst" placeholder="192.168.1.200" 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">è¾“å‡ºç«¯å£</label>
                <select v-model.number="newFlow.actions.output" 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500">
                  <option :value="null">é€‰æ‹©è¾“å‡ºç«¯å£...</option>
                  <option :value="1">1 - H1 (.100)</option>
                  <option :value="2">2 - H2 (.101)</option>
                  <option :value="3">3 - H3 (.102)</option>
                  <option :value="4">4 - H4 (.103)</option>
                  <option :value="5">5 - H5 (.104)</option>
                  <option :value="6">6 - H6 (.105)</option>
                  <option :value="7">7 - H7 (.108)</option>
                  <option :value="8">8 - H8 (.200)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä¼˜å…ˆçº§</label>
                <input type="number" v-model.number="newFlow.priority" value="100" 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500" />
              </div>
            </div>
          </div>
          
          <!-- åœºæ™¯2ï¼šå°ç¦é˜»æ­¢ -->
          <div v-if="newFlow.scenarioType === 'block'" class="bg-red-50 p-6 rounded-xl border-2 border-red-200">
            <h4 class="font-semibold text-red-900 mb-4 flex items-center gap-2">
              <span></span>
              <span>å°ç¦é˜»æ­¢é…ç½®</span>
            </h4>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æºIPï¼ˆè¦å°ç¦çš„IPï¼‰</label>
                <input type="text" v-model="newFlow.match.ipv4_src" placeholder="192.168.1.101" 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡IPï¼ˆç•™ç©º=å°ç¦æ‰€æœ‰ï¼‰</label>
                <input type="text" v-model="newFlow.match.ipv4_dst" placeholder="ç•™ç©ºæˆ–192.168.1.200" 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä¼˜å…ˆçº§ï¼ˆå»ºè®®200ï¼‰</label>
                <input type="number" v-model.number="newFlow.priority" value="200" 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-red-500" />
              </div>
            </div>
            <div class="mt-4 p-4 bg-red-100 rounded-lg">
              <p class="text-sm text-red-800"> æ³¨æ„ï¼šå°ç¦è§„åˆ™ä¸éœ€è¦è®¾ç½®è¾“å‡ºç«¯å£ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨DROPæ•°æ®åŒ…</p>
            </div>
          </div>
          
          <!-- åœºæ™¯3ï¼šé™é€Ÿæ§åˆ¶ -->
          <div v-if="newFlow.scenarioType === 'ratelimit'" class="bg-yellow-50 p-6 rounded-xl border-2 border-yellow-200">
            <h4 class="font-semibold text-yellow-900 mb-4 flex items-center gap-2">
              <span></span>
              <span>é™é€Ÿæ§åˆ¶é…ç½®</span>
            </h4>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æºIPï¼ˆè¦é™é€Ÿçš„IPï¼‰</label>
                <input type="text" v-model="newFlow.match.ipv4_src" placeholder="192.168.1.102" 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">é™é€Ÿçº§åˆ«</label>
                <select v-model.number="newFlow.actions.queue_id" 
                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500">
                  <option :value="null">ä¸é™é€Ÿ</option>
                  <option :value="1"> ä½é€Ÿ (256Kbps)</option>
                  <option :value="2"> ä¸­é€Ÿ (1024Kbps)</option>
                  <option :value="3"> é«˜é€Ÿ (2048Kbps)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ä¼˜å…ˆçº§</label>
                <input type="number" v-model.number="newFlow.priority" value="120" 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500" />
              </div>
            </div>
            <div class="mt-4 p-4 bg-yellow-100 rounded-lg">
              <p class="text-sm text-yellow-800"> æç¤ºï¼šé™é€Ÿåæ•°æ®åŒ…ä¼šä½¿ç”¨NORMALè½¬å‘</p>
            </div>
          </div>
          
          <!-- åœºæ™¯4ï¼šè‡ªå®šä¹‰ -->
          <div v-if="newFlow.scenarioType === 'custom'" class="bg-purple-50 p-6 rounded-xl border-2 border-purple-200">
            <h4 class="font-semibold text-purple-900 mb-4"> è‡ªå®šä¹‰é…ç½®ï¼ˆé«˜çº§ï¼‰</h4>
            <p class="text-sm text-gray-600 mb-4">è¯·ä½¿ç”¨å¿«é€Ÿåœºæ™¯æ¨¡æ¿æˆ–æŸ¥çœ‹æ–‡æ¡£</p>
            <button @click="showTemplateModal = true; showAddModal = false" 
                    class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
              æŸ¥çœ‹å¿«é€Ÿåœºæ™¯
            </button>
          </div>  
        </div>
        
        <!-- åº•éƒ¨æŒ‰é’® -->
        <div v-if="newFlow.scenarioType" class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
          <button @click="showAddModal = false" 
                  class="px-8 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-50 transition-all font-medium text-gray-700">
            å–æ¶ˆ
          </button>
          <button @click="handleAddFlowClick" 
                  class="px-8 py-3 bg-blue-500 text-white rounded-xl hover:shadow-lg transition-all font-medium">
            æ·»åŠ æµè¡¨
          </button>
        </div>
      </div>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div v-if="showDetailsModal" class="modal-overlay" @click.self="showDetailsModal = false">
      <div class="modal">
        <h3>æµè¡¨è¯¦æƒ…</h3>
        <pre>{{ JSON.stringify(selectedFlow, null, 2) }}</pre>
        <button @click="showDetailsModal = false">å…³é—­</button>
      </div>
    </div>
    
    <!-- å¿«é€Ÿåœºæ™¯æ¨¡æ€æ¡† -->
    <div v-if="showTemplateModal" class="modal-overlay" @click.self="showTemplateModal = false">
      <div class="modal large">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">ğŸ“‹ å¿«é€Ÿåœºæ™¯æ¨¡æ¿</h3>
          <button @click="showTemplateModal = false" class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- åœºæ™¯1: ä¸»æœºé—´å®šå‘è½¬å‘ -->
          <div class="template-card" @click="applyTemplate(1)">
            <div class="template-header">
              <span class="template-icon">ğŸ¯</span>
              <h4 class="template-title">åœºæ™¯1: ä¸»æœºé—´å®šå‘è½¬å‘</h4>
            </div>
            <p class="template-desc">H1 (192.168.1.100) â†’ H7 (192.168.1.200) ç²¾å‡†è½¬å‘</p>
            <div class="template-details">
              <div class="text-xs text-gray-600">
                <div>â€¢ åŒ¹é…: æºIP=.100, ç›®æ ‡IP=.200</div>
                <div>â€¢ åŠ¨ä½œ: è¾“å‡ºåˆ°ç«¯å£ 8</div>
                <div>â€¢ ä¼˜å…ˆçº§: 100</div>
              </div>
            </div>
          </div>
          
          <!-- åœºæ™¯2: å°ç¦ç‰¹å®šIPè®¿é—® -->
          <div class="template-card" @click="applyTemplate(2)">
            <div class="template-header">
              <span class="template-icon">ğŸš«</span>
              <h4 class="template-title">åœºæ™¯2: å°ç¦IPè®¿é—®</h4>
            </div>
            <p class="template-desc">ç¦æ­¢ H2 (192.168.1.101) è®¿é—® H7</p>
            <div class="template-details">
              <div class="text-xs text-gray-600">
                <div>â€¢ åŒ¹é…: æºIP=.101, ç›®æ ‡IP=.200</div>
                <div>â€¢ åŠ¨ä½œ: æ— ï¼ˆä¸¢å¼ƒï¼‰</div>
                <div>â€¢ ä¼˜å…ˆçº§: 200 (é«˜äºæ™®é€šè½¬å‘)</div>
              </div>
            </div>
          </div>
          
          <!-- åœºæ™¯3: åªå…è®¸HTTPæµé‡ -->
          <div class="template-card" @click="applyTemplate(3)">
            <div class="template-header">
              <span class="template-icon">ğŸŒ</span>
              <h4 class="template-title">åœºæ™¯3: åªå…è®¸HTTPæµé‡</h4>
            </div>
            <p class="template-desc">åªå…è®¸ç«¯å£80çš„TCPæµé‡åˆ°è¾¾H7</p>
            <div class="template-details">
              <div class="text-xs text-gray-600">
                <div>â€¢ åŒ¹é…: ç›®æ ‡IP=.200, TCP, ç«¯å£80</div>
                <div>â€¢ åŠ¨ä½œ: è¾“å‡ºåˆ°ç«¯å£ 8</div>
                <div>â€¢ ä¼˜å…ˆçº§: 150</div>
              </div>
            </div>
          </div>
          
          <!-- åœºæ™¯4: ARPå­¦ä¹  -->
          <div class="template-card" @click="applyTemplate(4)">
            <div class="template-header">
              <span class="template-icon">ğŸ“š</span>
              <h4 class="template-title">åœºæ™¯4: ARPå­¦ä¹ </h4>
            </div>
            <p class="template-desc">æ‰€æœ‰ARPè¯·æ±‚å‘é€ç»™æ§åˆ¶å™¨</p>
            <div class="template-details">
              <div class="text-xs text-gray-600">
                <div>â€¢ åŒ¹é…: ä»¥å¤ªç½‘ç±»å‹=ARP (0x0806)</div>
                <div>â€¢ åŠ¨ä½œ: CONTROLLER</div>
                <div>â€¢ ä¼˜å…ˆçº§: 50</div>
              </div>
            </div>
          </div>
          
          <!-- åœºæ™¯5: é™é€Ÿä½é€ŸIP -->
          <div class="template-card" @click="applyTemplate(5)">
            <div class="template-header">
              <span class="template-icon">ğŸŒ</span>
              <h4 class="template-title">åœºæ™¯5: é™é€Ÿä½é€Ÿ (256K)</h4>
            </div>
            <p class="template-desc">å¯¹ H3 (192.168.1.102) åº”ç”¨ä½é€Ÿé™åˆ¶</p>
            <div class="template-details">
              <div class="text-xs text-gray-600">
                <div>â€¢ åŒ¹é…: æºIP=.102</div>
                <div>â€¢ åŠ¨ä½œ: FLOOD + é˜Ÿåˆ—ID=1 (ä½é€Ÿ)</div>
                <div>â€¢ ä¼˜å…ˆçº§: 120</div>
              </div>
            </div>
          </div>
          
          <!-- åœºæ™¯6: é™é€Ÿä¸­é€Ÿ -->
          <div class="template-card" @click="applyTemplate(6)">
            <div class="template-header">
              <span class="template-icon">ğŸ</span>
              <h4 class="template-title">åœºæ™¯6: é™é€Ÿä¸­é€Ÿ (1M)</h4>
            </div>
            <p class="template-desc">å¯¹ H4 (192.168.1.103) åº”ç”¨ä¸­é€Ÿé™åˆ¶</p>
            <div class="template-details">
              <div class="text-xs text-gray-600">
                <div>â€¢ åŒ¹é…: æºIP=.103</div>
                <div>â€¢ åŠ¨ä½œ: FLOOD + é˜Ÿåˆ—ID=2 (ä¸­é€Ÿ)</div>
                <div>â€¢ ä¼˜å…ˆçº§: 120</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
          <strong>âš ï¸ æ³¨æ„ï¼š</strong> ç‚¹å‡»åœºæ™¯å¡ç‰‡å°†ç›´æ¥å‘é€æµè¡¨åˆ°äº¤æ¢æœºï¼Œå¹¶åœ¨æ‹“æ‰‘å›¾ä¸Šæ˜¾ç¤ºåŠ¨ç”»ã€‚
        </div>
        
        <div class="modal-footer">
          <button @click="showTemplateModal = false" class="btn-secondary">å…³é—­</button>
        </div>
      </div>
    </div>
    </main>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'
import ryuApi from '@/api/ryu'

const controllerOnline = ref(false)
const switches = ref<number[]>([])
const selectedSwitch = ref('')
const flows = ref<any[]>([])
const loading = ref(false)
const showAddModal = ref(false)
const showDetailsModal = ref(false)
const showTemplateModal = ref(false)
const selectedFlow = ref<any>(null)
const showFlowAnimation = ref(false)
const flowAnimSrc = ref({ x: 400, y: 200 })
const flowAnimDst = ref({ x: 400, y: 200 })
// âœ… ç”¨äºè·Ÿè¸ªå½“å‰æ˜¾ç¤ºç®­å¤´çš„æµè¡¨ä¿¡æ¯
// @ts-ignore - è¿™ä¸ªå˜é‡åœ¨setIntervalä¸­ä½¿ç”¨ï¼ŒTypeScriptè¯¯æŠ¥
const currentAnimatedFlow = ref<{srcIp: string, dstIp: string, priority: number} | null>(null)
const flowCheckInterval = ref<number | null>(null)

// âœ… è®¾å¤‡å¼‚å¸¸æ•°æ®
const deviceAnomalies = ref<any[]>([])
const statusFilter = ref<'all' | 'pending' | 'handled'>('all')

const newFlow = ref({
  scenarioType: '',  // âœ… åœºæ™¯ç±»å‹ï¼šforward, block, ratelimit, custom
  priority: 100,
  idle_timeout: 0,
  match: { 
    in_port: null, 
    eth_src: null, 
    eth_dst: null,
    eth_type: null,
    ipv4_src: null,
    ipv4_dst: null,
    ip_proto: null,
    tcp_src: null,
    tcp_dst: null
  },
  actions: { output: null, queue_id: null }
})

// IPåœ°å€ä¸æ‹“æ‰‘å›¾åæ ‡çš„æ˜ å°„
const ipToCoords: Record<string, {x: number, y: number}> = {
  '192.168.1.100': { x: 400, y: 50 },   // H1
  '192.168.1.108': { x: 550, y: 100 },  // H8
  '192.168.1.101': { x: 600, y: 200 },  // H2
  '192.168.1.102': { x: 550, y: 300 },  // H3
  '192.168.1.103': { x: 400, y: 350 },  // H4
  '192.168.1.104': { x: 250, y: 300 },  // H5
  '192.168.1.105': { x: 200, y: 200 },  // H6
  '192.168.1.200': { x: 250, y: 100 },  // H7
  'switch': { x: 400, y: 200 }          // S1
}

const selectHost = (hostName: string) => {
  console.log(`é€‰ä¸­ä¸»æœº: ${hostName}`)
  // å¯ä»¥æ‰©å±•ï¼šç‚¹å‡»ä¸»æœºåè‡ªåŠ¨å¡«å……IPåœ°å€åˆ°è¡¨å•
}

const checkControllerStatus = async () => {
  try {
    const res = await ryuApi.getSDNControllerStatus()
    controllerOnline.value = res.status === 'online'
  } catch (e) {
    controllerOnline.value = false
  }
}

const loadSwitches = async () => {
  try {
    const res = await ryuApi.getSDNSwitches()
    if (res.success) {
      switches.value = res.switches
      // âœ… è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªäº¤æ¢æœºï¼ˆå¦‚æœå½“å‰æ²¡æœ‰é€‰ä¸­ï¼‰
      if (switches.value.length > 0 && !selectedSwitch.value) {
        selectedSwitch.value = String(switches.value[0])  // âœ… ä¿®å¤ï¼šnumberè½¬string
        await loadFlows()
      }
    }
  } catch (e) {
    console.error(e)
  }
}

const loadFlows = async () => {
  if (!selectedSwitch.value) return
  loading.value = true
  try {
    const res = await ryuApi.getSDNSwitchFlows(selectedSwitch.value)
    if (res.success) flows.value = res.flows
  } catch (e) {
    console.error(e)
  } finally {
    loading.value = false
  }
}

const refreshData = async () => {
  await checkControllerStatus()
  await loadSwitches()
  // loadSwitches ä¸­å·²ç»å¤„ç†äº†è‡ªåŠ¨é€‰ä¸­å’ŒåŠ è½½æµè¡¨
}

const handleAddFlowClick = () => {
  console.log('[æäº¤æŒ‰é’®] newFlow.value:', JSON.parse(JSON.stringify(newFlow.value)))
  addFlow()
}

const addFlow = async (flowData?: any, skipAnimation = false) => {
  if (!selectedSwitch.value) return
  
  // âœ… å…³é”®ä¿®å¤ï¼šå…ˆç¡®ä¿ newFlow.value.actions å­˜åœ¨
  if (!flowData && !newFlow.value.actions) {
    console.error('[addFlow] âŒ newFlow.value.actions æ˜¯ undefinedï¼Œå¼ºåˆ¶åˆå§‹åŒ–ï¼')
    newFlow.value.actions = { output: null, queue_id: null }
  }
  
  const flow = flowData || newFlow.value
  
  // âœ… è°ƒè¯•æ—¥å¿—ï¼šæ‰“å°å½“å‰flowå¯¹è±¡
  console.log('[addFlow] å¼€å§‹æ·»åŠ æµè¡¨ï¼Œflowå¯¹è±¡:', JSON.parse(JSON.stringify(flow)))
  console.log('[addFlow] flow.actions:', flow.actions)
  console.log('[addFlow] flow.actions?.output:', flow.actions?.output)
  
  // âœ… é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ match å’Œ actions å¯¹è±¡å­˜åœ¨
  if (!flow.match) {
    flow.match = {
      in_port: null,
      eth_src: null,
      eth_dst: null,
      eth_type: null,
      ipv4_src: null,
      ipv4_dst: null,
      ip_proto: null,
      tcp_src: null,
      tcp_dst: null
    }
  }
  
  if (!flow.actions) {
    console.error('[addFlow] âŒ flow.actions æ˜¯ undefinedï¼Œå¼ºåˆ¶åˆå§‹åŒ–ï¼')
    flow.actions = {
      output: null,
      queue_id: null
    }
  }
  
  // âœ… æ ¹æ®åœºæ™¯ç±»å‹è‡ªåŠ¨è®¾ç½®å‚æ•°
  if (flow.scenarioType === 'block') {
    // å°ç¦åœºæ™¯ï¼šä¸éœ€è¦è¾“å‡ºç«¯å£
    flow.actions.output = null
    flow.match.eth_type = 0x0800  // IPv4
  } else if (flow.scenarioType === 'ratelimit') {
    // é™é€Ÿåœºæ™¯ï¼šä½¿ç”¨NORMALè½¬å‘ï¼ˆè€ŒéFLOODï¼‰
    flow.actions.output = 4294967290  // OFPP_NORMAL = 0xfffffffa
    flow.match.eth_type = 0x0800  // IPv4
  } else if (flow.scenarioType === 'forward') {
    // è½¬å‘åœºæ™¯ï¼šéœ€è¦è¾“å‡ºç«¯å£
    if (!flow.actions.output) {
      alert('è¯·é€‰æ‹©è¾“å‡ºç«¯å£')
      return
    }
    flow.match.eth_type = 0x0800  // IPv4
  }
  
  try {
    // âœ… ç¡®ä¿æ‰€æœ‰æ•°å€¼å‚æ•°éƒ½æ˜¯æ•´æ•°ç±»å‹
    const flowEntry: any = { 
      priority: parseInt(flow.priority) || 100,
      idle_timeout: parseInt(flow.idle_timeout) || 0,
      hard_timeout: 0,
      match: {}, 
      actions: [] 
    }
    
    // æ„å»ºåŒ¹é…å­—æ®µï¼ˆæ‰€æœ‰è®¿é—®éƒ½åŠ ä¸Š flow.match å­˜åœ¨æ€§æ£€æŸ¥ï¼Œå¹¶ç¡®ä¿æ•°å€¼ç±»å‹æ­£ç¡®ï¼‰
    if (flow.match) {
      // âœ… å¼ºåˆ¶æ·»åŠ eth_typeï¼ˆæ‰€æœ‰åœºæ™¯éƒ½éœ€è¦ï¼‰
      flowEntry.match.eth_type = parseInt(flow.match.eth_type) || 0x0800
      
      // å…¶ä»–åŒ¹é…å­—æ®µ
      if (flow.match.in_port) flowEntry.match.in_port = parseInt(flow.match.in_port)
      if (flow.match.eth_src) flowEntry.match.eth_src = flow.match.eth_src
      if (flow.match.eth_dst) flowEntry.match.eth_dst = flow.match.eth_dst
      if (flow.match.ipv4_src && flow.match.ipv4_src.trim()) {
        flowEntry.match.ipv4_src = flow.match.ipv4_src.trim()
      }
      if (flow.match.ipv4_dst && flow.match.ipv4_dst.trim()) {
        flowEntry.match.ipv4_dst = flow.match.ipv4_dst.trim()
      }
      if (flow.match.ip_proto) flowEntry.match.ip_proto = parseInt(flow.match.ip_proto)
      if (flow.match.tcp_src) flowEntry.match.tcp_src = parseInt(flow.match.tcp_src)
      if (flow.match.tcp_dst) flowEntry.match.tcp_dst = parseInt(flow.match.tcp_dst)
    }
    
    console.log('[addFlow] æ„å»ºçš„flowEntry:', JSON.stringify(flowEntry, null, 2))
    
    // âœ… æ·»åŠ åŠ¨ä½œï¼ˆç¡®ä¿ port æ˜¯æ•´æ•°æˆ–ç‰¹æ®Šå€¼ï¼‰
    let outputPort = flow.actions?.output
    
    // å°ç¦åœºæ™¯ï¼šä¸æ·»åŠ OUTPUTåŠ¨ä½œï¼ˆportä¸ºnull = DROPï¼‰
    if (outputPort === null || outputPort === undefined) {
      console.log('[addFlow] å°ç¦åœºæ™¯ï¼šä¸æ·»åŠ OUTPUTåŠ¨ä½œï¼ˆactionsä¸ºç©ºæ•°ç»„=DROPï¼‰')
      // âœ… ä¸æ·»åŠ ä»»ä½•actionï¼Œactionsä¿æŒä¸ºç©ºæ•°ç»„
    } else {
      // è½¬å‘/é™é€Ÿåœºæ™¯ï¼šæ·»åŠ OUTPUTåŠ¨ä½œ
      outputPort = parseInt(outputPort)
      const action: any = { type: 'OUTPUT', port: outputPort }
      if (flow.actions?.queue_id) action.queue_id = parseInt(flow.actions.queue_id)
      flowEntry.actions.push(action)
      console.log('[addFlow] æ·»åŠ OUTPUTåŠ¨ä½œ:', action)
    }
    
    const res = await ryuApi.addSDNFlowEntry(selectedSwitch.value, flowEntry)
    if (res.success) {
      alert('âœ… æµè¡¨æ·»åŠ æˆåŠŸï¼')
      showAddModal.value = false
      
      // æ˜¾ç¤ºåŠ¨ç”»
      if (!skipAnimation && flow.match) {
        showFlowAnimationEffect(flow.match.ipv4_src, flow.match.ipv4_dst)
      }
      
      // é‡ç½®è¡¨å•
      if (!flowData) {
        newFlow.value = { 
          scenarioType: '',
          priority: 100,
          idle_timeout: 0,
          match: { 
            in_port: null, eth_src: null, eth_dst: null,
            eth_type: null, ipv4_src: null, ipv4_dst: null,
            ip_proto: null, tcp_src: null, tcp_dst: null
          },
          actions: { output: null, queue_id: null }
        }
      }
      await loadFlows()
    }
  } catch (e: any) {
    alert('âŒ æ·»åŠ å¤±è´¥: ' + (e.response?.data?.detail || e.message))
  }
}

const showFlowAnimationEffect = (srcIp?: string, dstIp?: string) => {
  if (srcIp && ipToCoords[srcIp]) {
    flowAnimSrc.value = ipToCoords[srcIp]
  } else {
    flowAnimSrc.value = ipToCoords['switch']
  }
  
  if (dstIp && ipToCoords[dstIp]) {
    flowAnimDst.value = ipToCoords[dstIp]
  } else {
    flowAnimDst.value = ipToCoords['switch']
  }
  
  showFlowAnimation.value = true
  // âœ… å°†åŠ¨ç”»æ—¶é—´å»¶é•¿åˆ°60ç§’ï¼Œä¸æµè¡¨çš„idle_timeoutåŒæ­¥
  setTimeout(() => {
    showFlowAnimation.value = false
  }, 60000)
}

const applyTemplate = async (templateId: number) => {
  if (!selectedSwitch.value) return
  
  let templateFlow: any = null
  
  switch (templateId) {
    case 1: // åœºæ™¯1: ä¸»æœºé—´å®šå‘è½¬å‘ H1 -> H7
      templateFlow = {
        priority: 100,
        idle_timeout: 0,
        match: {
          ipv4_src: '192.168.1.100',
          ipv4_dst: '192.168.1.200',
          eth_type: 0x0800
        },
        actions: { output: 8, queue_id: null }
      }
      break
      
    case 2: // åœºæ™¯2: å°ç¦IPè®¿é—® H2 -X-> H7
      templateFlow = {
        priority: 200,
        idle_timeout: 0,
        match: {
          ipv4_src: '192.168.1.101',
          ipv4_dst: '192.168.1.200',
          eth_type: 0x0800
        },
        actions: { output: null, queue_id: null } // æ— è¾“å‡º = ä¸¢å¼ƒ
      }
      // å°ç¦åœºæ™¯ç‰¹æ®Šå¤„ç†
      if (confirm('ç¡®å®šå°ç¦ 192.168.1.101 è®¿é—® 192.168.1.200ï¼Ÿï¼ˆæ•°æ®åŒ…å°†è¢«ä¸¢å¼ƒï¼‰')) {
        try {
          const flowEntry = {
            priority: 200,
            idle_timeout: 0,
            hard_timeout: 0,
            match: {
              ipv4_src: '192.168.1.101',
              ipv4_dst: '192.168.1.200',
              eth_type: 0x0800
            },
            actions: [] // ç©ºåŠ¨ä½œ = DROP
          }
          const res = await ryuApi.addSDNFlowEntry(selectedSwitch.value, flowEntry)
          if (res.success) {
            alert('âœ… å°ç¦æµè¡¨æ·»åŠ æˆåŠŸï¼')
            showFlowAnimationEffect('192.168.1.101', '192.168.1.200')
            showTemplateModal.value = false
            await loadFlows()
          }
        } catch (e: any) {
          alert('âŒ æ·»åŠ å¤±è´¥: ' + (e.response?.data?.detail || e.message))
        }
      }
      return
      
    case 3: // åœºæ™¯3: åªå…è®¸HTTPæµé‡
      // âœ… ç‰¹æ®Šå¤„ç†ï¼šéœ€è¦æ·»åŠ ä¸¤æ¡æµè¡¨
      if (confirm('åœºæ™¯3å°†æ·»åŠ ä¸¤æ¡æµè¡¨ï¼šâ‘ å…è®¸HTTP(TCP 80)ã€â‘¡é˜»æ­¢å…¶ä»–æµé‡åˆ°H7ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) {
        try {
          // ç¬¬1æ¡ï¼šå…è®¸HTTPæµé‡
          const httpFlow = {
            priority: 150,
            idle_timeout: 0,
            hard_timeout: 0,
            match: {
              ipv4_dst: '192.168.1.200',
              eth_type: 0x0800,
              ip_proto: 6,  // TCP
              tcp_dst: 80
            },
            actions: [{ type: 'OUTPUT', port: 8 }]
          }
          await ryuApi.addSDNFlowEntry(selectedSwitch.value, httpFlow)
          
          // ç¬¬2æ¡ï¼šé˜»æ­¢å…¶ä»–æµé‡åˆ°H7ï¼ˆä¼˜å…ˆçº§æ›´ä½ï¼‰
          const blockFlow = {
            priority: 100,
            idle_timeout: 0,
            hard_timeout: 0,
            match: {
              ipv4_dst: '192.168.1.200',
              eth_type: 0x0800
            },
            actions: [] // ç©ºåŠ¨ä½œ = DROP
          }
          const res = await ryuApi.addSDNFlowEntry(selectedSwitch.value, blockFlow)
          
          if (res.success) {
            alert('âœ… åœºæ™¯3æµè¡¨æ·»åŠ æˆåŠŸï¼ç°åœ¨åªå…è®¸HTTPæµé‡åˆ°H7')
            showTemplateModal.value = false
            await loadFlows()
          }
        } catch (e: any) {
          alert('âŒ æ·»åŠ å¤±è´¥: ' + (e.response?.data?.detail || e.message))
        }
      }
      return
      
    case 4: // åœºæ™¯4: ARPå­¦ä¹ 
      templateFlow = {
        priority: 50,
        idle_timeout: 0,
        match: {
          eth_type: 0x0806  // ARP
        },
        actions: { output: 4294967293, queue_id: null } // CONTROLLER
      }
      break
      
    case 5: // åœºæ™¯5: é™é€Ÿä½é€Ÿ H3
      templateFlow = {
        priority: 120,
        idle_timeout: 0,
        match: {
          ipv4_src: '192.168.1.102',
          eth_type: 0x0800
        },
        actions: { output: 4294967290, queue_id: 1 } // NORMAL + ä½é€Ÿé˜Ÿåˆ—
      }
      break
      
    case 6: // åœºæ™¯6: é™é€Ÿä¸­é€Ÿ H4
      templateFlow = {
        priority: 120,
        idle_timeout: 0,
        match: {
          ipv4_src: '192.168.1.103',
          eth_type: 0x0800
        },
        actions: { output: 4294967290, queue_id: 2 } // NORMAL + ä¸­é€Ÿé˜Ÿåˆ—
      }
      break
  }
  
  if (templateFlow) {
    showTemplateModal.value = false
    await addFlow(templateFlow)
  }
}

const deleteFlow = async (flow: any) => {
  if (!confirm('ç¡®å®šåˆ é™¤?')) return
  try {
    const res = await ryuApi.deleteSDNFlowEntry(selectedSwitch.value, flow)
    if (res.success) {
      alert('åˆ é™¤æˆåŠŸ')
      await loadFlows()
    }
  } catch (e: any) {
    alert('åˆ é™¤å¤±è´¥: ' + (e.response?.data?.detail || e.message))
  }
}

// âœ… ç§»é™¤æœªä½¿ç”¨çš„å‡½æ•°ï¼ˆå·²æ³¨é‡Šï¼Œå¦‚éœ€è¦å¯å–æ¶ˆæ³¨é‡Šï¼‰
// const deleteAllFlows = async () => {
//   if (!confirm('ç¡®å®šåˆ é™¤æ‰€æœ‰æµè¡¨?')) return
//   try {
//     const res = await ryuApi.deleteSDNAllFlows(selectedSwitch.value)
//     if (res.success) {
//       alert('æ‰€æœ‰æµè¡¨å·²åˆ é™¤')
//       await loadFlows()
//     }
//   } catch (e: any) {
//     alert('åˆ é™¤å¤±è´¥: ' + (e.response?.data?.detail || e.message))
//   }
// }

const viewDetails = (flow: any) => {
  selectedFlow.value = flow
  showDetailsModal.value = true
}

const formatBytes = (bytes: number) => {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
}

const formatAction = (action: any) => {
  if (action.type === 'OUTPUT') {
    // å¤„ç†ç‰¹æ®Šçš„OpenFlowç«¯å£å¸¸é‡
    const portValue = action.port_name || action.port
    const portMap: Record<string | number, string> = {
      'FLOOD': 'NORMAL',  // å°†FLOODæ˜¾ç¤ºä¸ºNORMAL
      'CONTROLLER': 'NORMAL',  // å°†CONTROLLERæ˜¾ç¤ºä¸ºNORMAL
      4294967291: 'NORMAL',  // FLOODçš„æ•°å€¼
      4294967293: 'NORMAL'   // NORMALçš„æ•°å€¼
    }
    
    // å¦‚æœæ˜¯ç‰¹æ®Šç«¯å£ï¼Œä½¿ç”¨æ˜ å°„è¡¨
    if (portMap[portValue]) {
      return `ğŸ“¤ ${portMap[portValue]}è½¬å‘`
    }
    
    // ä¼˜å…ˆä½¿ç”¨å¯è¯»çš„ç«¯å£åç§°
    if (action.port_name) {
      return `ğŸ“¤ è¾“å‡ºåˆ° ${action.port_name}`
    }
    return `ğŸ“¤ è¾“å‡ºåˆ°ç«¯å£ ${action.port}`
  }
  if (action.type === 'SET_QUEUE') {
    return `âš¡ é™é€Ÿé˜Ÿåˆ— ${action.queue_id}`
  }
  if (action.type === 'DROP') {
    return 'ğŸš« ä¸¢å¼ƒ (DROP)'
  }
  return JSON.stringify(action)
}

// âœ… æ ¼å¼åŒ–åŒ¹é…å­—æ®µçš„keyï¼ˆæ›´æ˜“è¯»ï¼‰
const formatMatchKey = (key: string | number): string => {
  const keyStr = String(key)
  const keyMap: Record<string, string> = {
    'eth_type': 'ä»¥å¤ªç½‘ç±»å‹',
    'ipv4_src': 'æºIP',
    'ipv4_dst': 'ç›®æ ‡IP',
    'in_port': 'è¾“å…¥ç«¯å£',
    'eth_src': 'æºMAC',
    'eth_dst': 'ç›®æ ‡MAC',
    'ip_proto': 'IPåè®®',
    'tcp_src': 'æºç«¯å£(TCP)',
    'tcp_dst': 'ç›®æ ‡ç«¯å£(TCP)',
    'udp_src': 'æºç«¯å£(UDP)',
    'udp_dst': 'ç›®æ ‡ç«¯å£(UDP)'
  }
  return keyMap[keyStr] || keyStr
}

// âœ… æ ¼å¼åŒ–åŒ¹é…å­—æ®µçš„value
const formatMatchValue = (key: string | number, value: any): string => {
  const keyStr = String(key)
  if (keyStr === 'eth_type') {
    // ä»¥å¤ªç½‘ç±»å‹çš„åå…­è¿›åˆ¶è½¬æ¢
    const numValue: number = typeof value === 'number' ? value : parseInt(String(value), 10)
    const typeMap: { [key: number]: string } = {
      2048: 'IPv4',     // 0x0800
      2054: 'ARP',      // 0x0806
      34525: 'IPv6'     // 0x86dd
    }
    return typeMap[numValue] || `0x${numValue.toString(16)}`
  }
  if (keyStr === 'ip_proto') {
    const numValue: number = typeof value === 'number' ? value : parseInt(String(value), 10)
    const protoMap: { [key: number]: string } = {
      1: 'ICMP',
      6: 'TCP',
      17: 'UDP'
    }
    return protoMap[numValue] || String(value)
  }
  return String(value)
}

// âœ… åŠ è½½è®¾å¤‡å¼‚å¸¸åˆ—è¡¨ï¼ˆæ”¯æŒçŠ¶æ€ç­›é€‰ï¼Œhoursä¸ºç©º=å…¨éƒ¨ï¼‰
const loadDeviceAnomalies = async () => {
  try {
    const statusParam = statusFilter.value === 'all' ? null : statusFilter.value
    const res = await ryuApi.getDeviceAnomalies(null, statusParam)
    if (res && res.success && res.data) {
      deviceAnomalies.value = res.data
      console.log(`âœ… è®¾å¤‡å¼‚å¸¸åŠ è½½æˆåŠŸï¼ˆ${statusFilter.value}ï¼‰:`, deviceAnomalies.value.length)
    }
  } catch (e: any) {
    console.error('âŒ åŠ è½½è®¾å¤‡å¼‚å¸¸å¤±è´¥:', e)
  }
}

// âœ… æ ‡è®°å¼‚å¸¸ä¸ºå·²å¤„ç†
const markAnomalyAsResolved = async (anomalyId: number) => {
  try {
    console.log(`[DEBUG] å¼€å§‹æ ‡è®°å¼‚å¸¸ ${anomalyId} ä¸ºå·²å¤„ç†`)
    const res = await ryuApi.updateDeviceAnomalyStatus(anomalyId, 'handled')
    console.log(`[DEBUG] åç«¯è¿”å›: ${JSON.stringify(res)}`)
    
    // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºæˆåŠŸ
    if (res && (res.success === true || res.success === 'true')) {
      await loadDeviceAnomalies()
      console.log(`âœ… å¼‚å¸¸ ${anomalyId} å·²æ ‡è®°ä¸ºå·²å¤„ç†`)
    } else if (res && res.message) {
      await loadDeviceAnomalies()
      console.log(`âœ… å¼‚å¸¸ ${anomalyId} å·²å¤„ç†: ${res.message}`)
    } else {
      console.error(`âŒ æ ‡è®°å¤±è´¥ï¼Œå“åº”: ${JSON.stringify(res)}`)
      alert('âŒ æ ‡è®°å¤±è´¥: ' + (res?.message || 'æœªçŸ¥é”™è¯¯'))
    }
  } catch (e: any) {
    console.error(`[ERROR] æ ‡è®°å¼‚å¸¸ ${anomalyId} æ—¶å‡ºé”™:`, e)
    
    const status = e.response?.status
    const detail = e.response?.data?.detail || e.message || 'æœªçŸ¥é”™è¯¯'
    
    if (status === 404) {
      await loadDeviceAnomalies()
      console.warn(`âš ï¸ å¼‚å¸¸ ${anomalyId} å·²ä¸å­˜åœ¨ï¼Œè§†ä¸ºå·²å¤„ç†ã€‚`)
    } else if (status === 500) {
      alert(`âŒ æœåŠ¡å™¨é”™è¯¯: ${detail}`)
    } else {
      alert(`âŒ æ ‡è®°å¤±è´¥: ${detail}`)
    }
  }
}

onMounted(() => {
  refreshData()
  // âœ… åŠ è½½è®¾å¤‡å¼‚å¸¸
  loadDeviceAnomalies()
  
  // âœ… æ¯30ç§’è‡ªåŠ¨åˆ·æ–°è®¾å¤‡å¼‚å¸¸ï¼ˆå®æ—¶ç›‘æ§ï¼‰
  setInterval(() => {
    loadDeviceAnomalies()
  }, 30000)
})

// âœ… ç»„ä»¶å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
onUnmounted(() => {
  if (flowCheckInterval.value) {
    clearInterval(flowCheckInterval.value)
    flowCheckInterval.value = null
  }
})
</script>

<style scoped>
/* æ‹“æ‰‘å›¾æ ·å¼ */
.topology-container {
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-radius: 12px;
  padding: 2rem;
  min-height: 400px;
}

.host {
  cursor: pointer;
  transition: all 0.3s ease;
}

.host:hover circle {
  filter: brightness(1.2);
  stroke-width: 3;
}

.host:hover {
  transform: scale(1.05);
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-indicator {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.status-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.status-indicator.online .status-dot {
  background: #10b981;
  box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

.status-indicator.offline .status-dot {
  background: #ef4444;
  box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* çŠ¶æ€å¾½ç« æ ·å¼ */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 600;
  transition: all 0.2s;
}

.status-online {
  background: #d1fae5;
  color: #065f46;
  border: 2px solid #10b981;
}

.status-offline {
  background: #fee2e2;
  color: #991b1b;
  border: 2px solid #ef4444;
}

.status-badge .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.status-online .status-dot {
  background: #10b981;
}

.status-offline .status-dot {
  background: #ef4444;
}

/* ä¼˜åŒ–è¡¨æ ¼æ ·å¼ */
.flows-table {
  border-collapse: separate;
  border-spacing: 0;
}

.flows-table thead th {
  background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
  padding: 1rem;
  font-weight: 600;
  color: #374151;
  border-bottom: 2px solid #e5e7eb;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.flows-table thead th:first-child {
  border-top-left-radius: 0.75rem;
}

.flows-table thead th:last-child {
  border-top-right-radius: 0.75rem;
}

.flows-table tbody tr {
  transition: all 0.2s;
}

.flows-table tbody tr:hover {
  background: #f9fafb;
  transform: scale(1.01);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.flows-table tbody td {
  padding: 1rem;
  border-bottom: 1px solid #f3f4f6;
}
.switch-selector { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; }
.switch-selector label { font-weight: 600; }
.switch-selector select { flex: 1; padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 8px; }
.switch-selector button { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
.btn-template { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
.stat-card { background: white; border-radius: 12px; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
.stat-card strong { font-size: 1.5rem; color: #667eea; }
.loading { background: white; border-radius: 12px; padding: 2rem; text-align: center; }
.flows-card { background: white; border-radius: 12px; padding: 1.5rem; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.danger-btn { padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; }
.flows-table { width: 100%; border-collapse: collapse; }
.flows-table th { background: #f9fafb; padding: 0.75rem; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; }
.flows-table td { padding: 1rem; border-bottom: 1px solid #e5e7eb; }
.btn-view, .btn-delete { padding: 0.25rem 0.75rem; border: none; border-radius: 6px; cursor: pointer; margin-right: 0.5rem; }
.btn-view { background: #3b82f6; color: white; }
.btn-delete { background: #ef4444; color: white; }
.empty { background: white; border-radius: 12px; padding: 3rem; text-align: center; color: #6b7280; }
.modal-overlay { 
  position: fixed; 
  top: 0; 
  left: 0; 
  right: 0; 
  bottom: 0; 
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display: flex; 
  align-items: center; 
  justify-content: center; 
  z-index: 1000;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal { 
  background: white; 
  border-radius: 16px; 
  padding: 2rem; 
  max-width: 500px; 
  width: 90%; 
  max-height: 80vh; 
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideUp 0.3s ease;
}

.modal.large {
  max-width: 900px;
}

@keyframes slideUp {
  from { 
    transform: translateY(30px);
    opacity: 0;
  }
  to { 
    transform: translateY(0);
    opacity: 1;
  }
}

.modal h3 { 
  margin-bottom: 1rem;
  color: #1f2937;
}

/* è¡¨å•ç½‘æ ¼å¸ƒå±€ */
.form-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 2rem;
}

@media (min-width: 768px) {
  .form-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

.form-section {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.section-title {
  font-size: 1rem;
  font-weight: 600;
  color: #667eea;
  margin-bottom: 0.5rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #e5e7eb;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.form-group label {
  font-size: 0.875rem;
  font-weight: 500;
  color: #374151;
}

.form-input {
  padding: 0.625rem;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 0.875rem;
  transition: all 0.2s;
}

.form-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.hint {
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 0.25rem;
}

.modal-footer { 
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid #e5e7eb;
  display: flex; 
  gap: 1rem; 
  justify-content: flex-end;
}

.modal-footer button { 
  padding: 0.625rem 1.5rem;
  border: none; 
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary { 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
}

.btn-secondary {
  background: #f3f4f6;
  color: #374151;
}

.btn-secondary:hover {
  background: #e5e7eb;
}

pre { 
  background: #f9fafb; 
  padding: 1rem; 
  border-radius: 8px; 
  overflow-x: auto; 
  font-size: 0.875rem;
  border: 1px solid #e5e7eb;
}

/* æµè¡¨åŠ¨ç”» */
.animated-arrow {
  animation: flowPulse 1.5s ease-in-out infinite;
  stroke-dasharray: 10 5;
  stroke-dashoffset: 0;
  animation: dash 1s linear infinite, flowPulse 1.5s ease-in-out infinite;
}

@keyframes dash {
  to {
    stroke-dashoffset: -15;
  }
}

@keyframes flowPulse {
  0%, 100% {
    opacity: 1;
    stroke-width: 3;
  }
  50% {
    opacity: 0.6;
    stroke-width: 4;
  }
}

.animated-text {
  animation: textFade 1.5s ease-in-out infinite;
}

@keyframes textFade {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* åœºæ™¯æ¨¡æ¿å¡ç‰‡ */
.template-card {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 1.5rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.template-card:hover {
  border-color: #667eea;
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
  transform: translateY(-4px);
}

.template-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.template-icon {
  font-size: 2rem;
}

.template-title {
  font-size: 1rem;
  font-weight: 600;
  color: #1f2937;
}

.template-desc {
  color: #6b7280;
  font-size: 0.875rem;
  margin-bottom: 1rem;
}

.template-details {
  background: #f9fafb;
  border-radius: 8px;
  padding: 0.75rem;
  border-left: 3px solid #667eea;
}
</style>
