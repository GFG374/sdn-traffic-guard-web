# 🧪 设备异常检测实操手册

## **📋 测试目标**

验证RYU控制器的4种设备异常检测功能是否正常工作，并在前端页面查看检测结果。

**测试环境：**
- RYU控制器：192.168.44.129:8080
- Mininet：8个主机（H1-H8）+ 1个交换机（S1）
- 前端页面：http://localhost:5176 → 流表管理

---

## **🎯 4种异常测试清单**

| 异常类型 | 严重等级 | 测试时长 | 难度 |
|---------|---------|---------|------|
| ✅ IP配置异常 | 🔴 HIGH | 2分钟 | ⭐ 简单 |
| ✅ MAC地址冲突 | 🔴 HIGH | 3分钟 | ⭐⭐ 中等 |
| ✅ 交换机断连 | 🔴 HIGH | 1分钟 | ⭐ 简单 |
| ✅ 端口频繁抖动 | 🟡 MEDIUM | 5分钟 | ⭐⭐⭐ 困难 |

---

## **🧪 测试1：IP配置异常**

### **⏱️ 预计用时：2分钟**

### **📝 测试步骤**

#### **Step 1: 打开Mininet**
```bash
# 启动Mininet（如果还没启动）
sudo mn --topo single,8 --controller=remote,ip=192.168.44.129,port=6653 --mac
```

#### **Step 2: 修改主机IP为错误网段**
```bash
mininet> h1 ifconfig h1-eth0 10.0.0.1 netmask 255.255.255.0
```
**说明：** 将H1的IP从 `192.168.1.100` 改成 `10.0.0.1`（不在合法网段）

#### **Step 3: 触发检测（发送数据包）**
```bash
mininet> h1 ping -c 1 192.168.1.101
```
**说明：** 让H1发送一个数据包，控制器会检测到异常IP

#### **Step 4: 查看RYU日志**
在RYU控制器终端查看输出：
```
🔧 [device_anomaly] IP配置异常: 主机IP 10.0.0.1 不在合法网段 192.168.1.0/24
```

#### **Step 5: 查看前端页面**
1. 打开浏览器：http://localhost:5176
2. 点击"流表管理"
3. 滚动到"设备异常监控"区域
4. 应该看到：
   - 🔴 **RED**卡片
   - 标签：**HIGH**
   - 标题：**IP配置异常**
   - 描述：主机IP 10.0.0.1 不在合法网段 192.168.1.0/24
   - 设备ID：switch_1_port_X
   - 状态：⏳ 待处理

#### **Step 6: 验证数据库记录**
```bash
mysql -u root -p
mysql> USE sdn_security;
mysql> SELECT * FROM device_anomalies WHERE anomaly_type='IP配置异常' ORDER BY detected_at DESC LIMIT 1;
```

#### **Step 7: 恢复正常（可选）**
```bash
mininet> h1 ifconfig h1-eth0 192.168.1.100 netmask 255.255.255.0
```

### **✅ 成功标准**
- ✅ RYU日志有异常输出
- ✅ 前端页面显示红色HIGH卡片
- ✅ 数据库有对应记录

---

## **🧪 测试2：MAC地址冲突**

### **⏱️ 预计用时：3分钟**

### **📝 测试步骤**

#### **Step 1: 查看H1的MAC地址**
```bash
mininet> h1 ifconfig
# 记住H1的MAC地址，例如: 00:00:00:00:00:01
```

#### **Step 2: 打开H1的Python环境**
```bash
mininet> xterm h1
```
在弹出的H1终端中执行：

#### **Step 3: 安装Scapy（如果没有）**
```bash
h1# pip install scapy
```

#### **Step 4: 伪造MAC地址从不同端口发送**
在H1的xterm中运行Python脚本：
```python
from scapy.all import *

# H1的真实MAC（Mininet默认分配）
real_mac = "00:00:00:00:00:01"

# 发送正常数据包（端口1）
pkt1 = Ether(src=real_mac)/IP(dst="192.168.1.101")/ICMP()
sendp(pkt1, iface="h1-eth0", count=1)

print("✅ 第一个包已发送（端口1）")
input("按Enter继续...")

# 这里需要通过修改交换机连接来模拟端口变化
# 因为Mininet限制，我们改用更简单的方法
```

#### **Step 5: 更简单的测试方法（推荐）**
使用Python脚本模拟MAC冲突：
```bash
mininet> py import time
mininet> py from mininet.net import Mininet
mininet> py net = Mininet.get()
mininet> py h1 = net.get('h1')
mininet> py h2 = net.get('h2')

# 修改H2的MAC为H1的MAC
mininet> py h2.setMAC('00:00:00:00:00:01', intf='h2-eth0')
mininet> py h2.cmd('ping -c 1 192.168.1.103')
```

#### **Step 6: 查看RYU日志**
```
🔧 [device_anomaly] MAC地址冲突: MAC 00:00:00:00:00:01 同时出现在交换机1端口1 和 端口2
```

#### **Step 7: 查看前端页面**
应该看到：
- 🔴 **RED**卡片
- 标签：**HIGH**
- 标题：**MAC地址冲突**
- 描述：MAC 00:00:00:00:00:01 同时出现在不同端口
- 状态：⏳ 待处理

### **✅ 成功标准**
- ✅ RYU日志有MAC冲突输出
- ✅ 前端页面显示红色HIGH卡片
- ✅ 数据库有对应记录

---

## **🧪 测试3：交换机断连**

### **⏱️ 预计用时：1分钟**

这是最简单的测试！

### **📝 测试步骤**

#### **Step 1: 直接退出Mininet**
```bash
mininet> exit
```
或者在Mininet运行的终端按 `Ctrl+C`

#### **Step 2: 查看RYU日志（立即）**
```
❌ 交换机 1 已断开
🔧 [device_anomaly] 交换机断连: 交换机 1 意外断开连接
```

#### **Step 3: 查看前端页面**
1. 刷新页面：http://localhost:5176
2. 滚动到"设备异常监控"
3. 应该看到：
   - 🔴 **RED**卡片
   - 标签：**HIGH**
   - 标题：**交换机断连**
   - 描述：交换机 1 意外断开连接
   - 设备ID：switch_1
   - 状态：⏳ 待处理

#### **Step 4: 验证数据库**
```sql
SELECT * FROM device_anomalies WHERE anomaly_type='交换机断连' ORDER BY detected_at DESC LIMIT 1;
```

#### **Step 5: 重新启动Mininet（恢复）**
```bash
sudo mn --topo single,8 --controller=remote,ip=192.168.44.129,port=6653 --mac
```
RYU日志应显示：
```
✅ 交换机 1 已连接
```

### **✅ 成功标准**
- ✅ RYU日志有断连输出
- ✅ 前端页面显示红色HIGH卡片
- ✅ 数据库有对应记录

---

## **🧪 测试4：端口频繁抖动**

### **⏱️ 预计用时：5分钟**

这是最复杂的测试，需要模拟端口频繁up/down！

### **📝 测试步骤**

#### **Step 1: 准备测试脚本**
创建文件：`e:\毕设\network-management-platform\SDN\port_flapping.py`

```python
#!/usr/bin/env python3
"""
端口抖动测试脚本
模拟端口在60秒内频繁up/down超过5次
"""
import time
import subprocess

def toggle_port(host, times=6, interval=8):
    """
    模拟端口抖动：关闭再启动端口
    
    Args:
        host: 主机名（如h1）
        times: 抖动次数（必须>5才能触发检测）
        interval: 每次间隔秒数（必须<60秒）
    """
    print(f"🔄 开始模拟 {host} 端口抖动测试...")
    print(f"   - 抖动次数: {times}")
    print(f"   - 每次间隔: {interval}秒")
    print(f"   - 总耗时: {times * interval}秒\n")
    
    for i in range(times):
        print(f"[{i+1}/{times}] 关闭端口...")
        # 禁用端口
        subprocess.run(
            f"sudo ovs-ofctl mod-port s1 {host.replace('h', '')} down",
            shell=True
        )
        time.sleep(interval / 2)
        
        print(f"[{i+1}/{times}] 启动端口...")
        # 启用端口
        subprocess.run(
            f"sudo ovs-ofctl mod-port s1 {host.replace('h', '')} up",
            shell=True
        )
        time.sleep(interval / 2)
        
        print(f"   ✅ 第{i+1}次抖动完成\n")
    
    print("🎉 测试完成！请检查RYU日志和前端页面")

if __name__ == "__main__":
    # 测试H1的端口（端口号为1）
    toggle_port("h1", times=6, interval=8)
```

#### **Step 2: 运行测试脚本**
```bash
cd e:\毕设\network-management-platform\SDN
python port_flapping.py
```

脚本会自动执行：
```
🔄 开始模拟 h1 端口抖动测试...
   - 抖动次数: 6
   - 每次间隔: 8秒
   - 总耗时: 48秒

[1/6] 关闭端口...
[1/6] 启动端口...
   ✅ 第1次抖动完成

[2/6] 关闭端口...
...
```

#### **Step 3: 观察RYU日志（实时）**
在第5-6次抖动后，应该看到：
```
🔧 [device_anomaly] 端口频繁抖动: 交换机 1 端口 1 在60秒内up/down 6次
```

#### **Step 4: 查看前端页面**
应该看到：
- 🟡 **YELLOW**卡片（注意：这是medium等级）
- 标签：**MEDIUM**
- 标题：**端口频繁抖动**
- 描述：交换机 1 端口 1 在60秒内up/down 6次
- 设备ID：switch_1_port_1
- 状态：⏳ 待处理

#### **Step 5: 验证数据库**
```sql
SELECT * FROM device_anomalies WHERE anomaly_type='端口频繁抖动' ORDER BY detected_at DESC LIMIT 1;
```

### **⚠️ 注意事项**
- 端口抖动必须在60秒内发生超过5次
- 每次抖动间隔建议8-10秒
- 如果60秒内不足5次，不会触发告警

### **✅ 成功标准**
- ✅ RYU日志有端口抖动输出
- ✅ 前端页面显示黄色MEDIUM卡片
- ✅ 数据库有对应记录
- ✅ 异常详情中包含抖动次数

---

## **📊 前端页面效果预览**

### **无异常时**
```
┌─────────────────────────────────────┐
│  ⚠️ 设备异常监控        [🔄 刷新]   │
├─────────────────────────────────────┤
│                                     │
│          ✅ (大绿勾)                │
│     系统运行正常                     │
│   未检测到设备异常                   │
│                                     │
└─────────────────────────────────────┘
```

### **有异常时**
```
┌─────────────────────────────────────────────────┐
│  ⚠️ 设备异常监控                  [🔄 刷新]     │
├─────────────────────────────────────────────────┤
│  ┌────────────┐  ┌────────────┐  ┌────────────┐│
│  │ 🔴 HIGH    │  │ 🔴 HIGH    │  │ 🟡 MEDIUM  ││
│  │ ⏳ 待处理   │  │ ⏳ 待处理   │  │ ⏳ 待处理   ││
│  │            │  │            │  │            ││
│  │IP配置异常  │  │MAC地址冲突 │  │端口频繁抖动││
│  │主机IP不在  │  │MAC同时出现 │  │端口抖动6次 ││
│  │合法网段    │  │在不同端口  │  │在60秒内    ││
│  │            │  │            │  │            ││
│  │switch_1... │  │switch_1    │  │switch_1..  ││
│  │2024-11-11  │  │2024-11-11  │  │2024-11-11  ││
│  └────────────┘  └────────────┘  └────────────┘│
└─────────────────────────────────────────────────┘
```

---

## **🔧 常见问题排查**

### **问题1：前端页面没有显示异常**

**可能原因：**
- 后端API未正常运行
- 数据库连接失败
- 前端未刷新

**排查步骤：**
```bash
# 1. 检查后端是否运行
curl http://localhost:8001/v1/device_anomalies

# 2. 检查数据库
mysql -u root -p -e "SELECT COUNT(*) FROM sdn_security.device_anomalies;"

# 3. 查看浏览器控制台（F12）
# 看是否有API请求错误
```

### **问题2：RYU日志没有异常输出**

**可能原因：**
- 检测逻辑未触发
- 数据包未到达控制器
- 日志级别过高

**排查步骤：**
```bash
# 1. 检查RYU日志级别
tail -f ryu.log | grep "ERROR\|device_anomaly"

# 2. 检查packet_in事件
tail -f ryu.log | grep "packet_in"

# 3. 验证数据包是否发送
mininet> h1 ping -c 1 192.168.1.101
```

### **问题3：数据库无记录**

**可能原因：**
- 数据库连接配置错误
- 表不存在
- 权限不足

**排查步骤：**
```bash
# 1. 验证数据库连接
mysql -u root -p -e "SHOW DATABASES;"

# 2. 验证表结构
mysql -u root -p sdn_security -e "SHOW TABLES;"

# 3. 检查表结构
mysql -u root -p sdn_security -e "DESC device_anomalies;"
```

---

## **📈 测试报告模板**

完成测试后，建议记录以下信息：

```markdown
# 设备异常检测测试报告

**测试时间：** 2024-11-11 19:30

## 测试结果汇总

| 异常类型 | 触发成功 | RYU日志 | 前端显示 | 数据库记录 |
|---------|---------|---------|---------|-----------|
| IP配置异常 | ✅ | ✅ | ✅ | ✅ |
| MAC地址冲突 | ✅ | ✅ | ✅ | ✅ |
| 交换机断连 | ✅ | ✅ | ✅ | ✅ |
| 端口频繁抖动 | ✅ | ✅ | ✅ | ✅ |

## 测试详情

### 1. IP配置异常
- 触发时间：19:31
- 异常IP：10.0.0.1
- 检测延迟：<1秒
- 前端显示：正常

### 2. MAC地址冲突
- 触发时间：19:35
- 冲突MAC：00:00:00:00:00:01
- 检测延迟：<1秒
- 前端显示：正常

### 3. 交换机断连
- 触发时间：19:38
- 交换机ID：1
- 检测延迟：即时
- 前端显示：正常

### 4. 端口频繁抖动
- 触发时间：19:42
- 端口号：1
- 抖动次数：6次
- 检测延迟：第6次后立即
- 前端显示：正常

## 问题记录

- 无

## 建议

- 所有功能正常运行
- 建议增加异常自动恢复功能
```

---

## **🎯 总结**

按照本手册操作，你应该能够：

✅ **验证4种设备异常检测功能**
✅ **在RYU日志中看到检测输出**
✅ **在前端页面看到可视化展示**
✅ **在数据库中查询到记录**

**建议测试顺序：**
1. 交换机断连（最简单）
2. IP配置异常（简单）
3. MAC地址冲突（中等）
4. 端口频繁抖动（复杂）

**预计总耗时：** 15-20分钟

---

**文档版本：** v2.0（实操版）  
**最后更新：** 2024-11-11  
**作者：** SDN Security Testing Team
