# 🧪 设备异常检测测试指南

## **📋 4种设备异常类型测试方法**

---

### **1️⃣ IP配置异常**

**检测逻辑：** 主机IP不在合法网段 `192.168.1.0/24`

**测试步骤：**

```bash
# 在Mininet中执行
mininet> h1 ifconfig h1-eth0 10.0.0.1 netmask 255.255.255.0

# 然后让h1发送数据包触发检测
mininet> h1 ping -c 1 192.168.1.101
```

**预期结果：**
- RYU日志输出：`🔧 [device_anomaly] IP配置异常: 主机IP 10.0.0.1 不在合法网段 192.168.1.0/24`
- 数据库 `device_anomalies` 表新增一条记录
- 前端页面显示红色警告卡片

**恢复正常：**
```bash
mininet> h1 ifconfig h1-eth0 192.168.1.100 netmask 255.255.255.0
```

---

### **2️⃣ MAC地址冲突**

**检测逻辑：** 同一MAC地址出现在不同的交换机端口

**测试步骤：**

```bash
# 方法1：在Mininet中手动改MAC地址
mininet> h2 ifconfig h2-eth0 hw ether 00:00:00:00:00:01  # 改成和h1相同的MAC

# 然后让h2发送数据包
mininet> h2 ping -c 1 192.168.1.100
```

**方法2（推荐）：** 使用Python脚本制造冲突

创建文件 `SDN/mac_conflict.py`:
```python
from scapy.all import *
import time

# H2发送伪造MAC的数据包
src_ip = "192.168.1.101"
fake_mac = "00:00:00:00:00:01"  # 伪造成H1的MAC

# 构造ARP请求
arp_pkt = Ether(src=fake_mac) / ARP(op=1, psrc=src_ip, pdst="192.168.1.100")

# 发送10个包
for i in range(10):
    sendp(arp_pkt, iface="h2-eth0", verbose=False)
    print(f"发送伪造MAC包 {i+1}/10")
    time.sleep(0.5)
```

运行：
```bash
mininet> h2 python3 mac_conflict.py
```

**预期结果：**
- RYU日志：`🔧 [device_anomaly] MAC地址冲突: MAC 00:00:00:00:00:01 同时出现在交换机1端口1 和 交换机1端口2`
- 严重等级：`high`

---

### **3️⃣ 交换机断连**

**检测逻辑：** OpenFlow交换机意外断开连接

**测试步骤：**

**方法1：停止Mininet**
```bash
mininet> exit
```

**方法2：使用ovs-ofctl断开连接**
```bash
# 在Mininet之外的终端执行
sudo ovs-vsctl del-controller s1
```

**方法3（推荐）：重启交换机**
```bash
# 在Mininet中
mininet> py net.configureControllerForAll()
mininet> py net.switches[0].stop()
```

**预期结果：**
- RYU日志：`❌ 交换机 1 已断开`
- RYU日志：`🔧 [device_anomaly] 交换机断连: 交换机 1 意外断开连接`
- 严重等级：`high`
- 前端控制器状态变为"离线"

**恢复：**
```bash
# 重启Mininet
sudo mn -c
sudo mn --topo single,8 --controller=remote,ip=192.168.44.129,port=6653 --mac
```

---

### **4️⃣ 端口频繁抖动**

**检测逻辑：** 60秒内同一端口up/down超过5次

**测试步骤：**

**方法1：手动模拟端口抖动**
```bash
# 在Mininet宿主机上执行（需要root权限）
# 找到对应的接口名（例如s1-eth1对应h1）
for i in {1..6}; do
    sudo ifconfig s1-eth1 down
    echo "端口down $i/6"
    sleep 1
    sudo ifconfig s1-eth1 up
    echo "端口up $i/6"
    sleep 1
done
```

**方法2（推荐）：Python脚本模拟**

创建 `SDN/port_flap.py`:
```python
import os
import time

port = "s1-eth1"  # 交换机s1连接h1的端口

print(f"开始模拟端口{port}抖动...")
for i in range(6):
    os.system(f"sudo ifconfig {port} down")
    print(f"[{i+1}/6] 端口 down")
    time.sleep(2)
    
    os.system(f"sudo ifconfig {port} up")
    print(f"[{i+1}/6] 端口 up")
    time.sleep(2)

print("测试完成！")
```

运行：
```bash
sudo python3 SDN/port_flap.py
```

**预期结果：**
- RYU日志：`🔧 [device_anomaly] 端口频繁抖动: 交换机 1 端口 1 在60秒内up/down 6次`
- 严重等级：`medium`

---

## **🎯 综合测试场景**

### **场景1：完整测试流程**

```bash
# 1. 启动Mininet
sudo mn --topo single,8 --controller=remote,ip=192.168.44.129,port=6653 --mac

# 2. 测试IP配置异常
mininet> h1 ifconfig h1-eth0 10.0.0.1
mininet> h1 ping -c 1 192.168.1.101

# 3. 测试MAC冲突
mininet> h2 ifconfig h2-eth0 hw ether 00:00:00:00:00:01
mininet> h2 ping -c 1 192.168.1.100

# 4. 查看前端页面（应该看到2条异常）
# 打开浏览器访问流表管理页面

# 5. 恢复网络
mininet> h1 ifconfig h1-eth0 192.168.1.100
mininet> h2 ifconfig h2-eth0 hw ether 00:00:00:00:00:02
```

---

## **📊 验证方法**

### **1. 查看RYU日志**
```bash
# RYU控制器终端应该看到类似输出
🔧 [device_anomaly] IP配置异常: 主机IP 10.0.0.1 不在合法网段 192.168.1.0/24
🔧 [device_anomaly] MAC地址冲突: MAC 00:00:00:00:00:01 同时出现在...
```

### **2. 查询数据库**
```sql
-- 查看所有设备异常
SELECT * FROM device_anomalies ORDER BY detected_at DESC LIMIT 10;

-- 查看今日异常统计
SELECT anomaly_type, severity, COUNT(*) as count 
FROM device_anomalies 
WHERE DATE(detected_at) = CURDATE()
GROUP BY anomaly_type, severity;
```

### **3. 前端页面验证**

访问 `http://localhost:5176` → 流表管理

应该看到：
- 🚨 **设备异常监控** 大卡片
- 异常卡片按严重等级显示颜色：
  - 🔴 RED：high（IP配置异常、MAC冲突、交换机断连）
  - 🟡 YELLOW：medium（端口抖动）
  - 🔵 BLUE：low
- 每个异常显示：
  - 类型标签
  - 详细描述
  - 设备ID
  - 检测时间
  - 状态（待处理/已解决）

---

## **⚠️ 注意事项**

1. **IP配置异常**：每个IP只会报警一次（已加入`ip_subnet_checked`集合）
2. **MAC冲突**：会覆盖旧的映射，每次变化都会报警
3. **端口抖动**：检测到后会重置计数器，避免重复报警
4. **交换机断连**：需要完全断开OpenFlow连接才会触发

---

## **🔧 故障排除**

### **问题1：没有检测到异常**
**解决方法：**
```bash
# 1. 检查RYU控制器是否运行
ps aux | grep ryu-manager

# 2. 查看RYU日志
tail -f /path/to/ryu.log

# 3. 检查数据库连接
mysql -u root -p -e "SELECT * FROM device_anomalies LIMIT 1;"
```

### **问题2：前端页面不显示**
**解决方法：**
```bash
# 1. 检查后端API
curl http://localhost:8001/v1/device_anomalies

# 2. 查看浏览器控制台
# F12 → Console，查看是否有错误

# 3. 手动刷新
# 点击"刷新"按钮
```

---

## **🎉 测试完成标准**

✅ 4种异常类型全部触发  
✅ RYU日志有对应输出  
✅ 数据库有记录  
✅ 前端页面正确显示  
✅ 异常卡片颜色和布局正确  
✅ 自动刷新功能正常（30秒）

---

**祝测试顺利！🚀**
